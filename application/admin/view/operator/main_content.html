<!-- å·¦è¾¹ç»Ÿè®¡ -->
 <style>
    .table-export-select{
        border: none !important;
    }
    /* éª¨æ¶å±æ ·å¼ */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row {
        height: 40px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
 </style>
<div class="col-md-8">
    <div class="row g-3 mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-primary wukong-btn wukong-btn-primary" id="showPerformanceBtn">
                <i class="bi bi-bar-chart-line"></i> æŸ¥çœ‹ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨
            </button>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card fold-card export">
                <div class="wukong-table-card-header">
                    <span>ä¸šåŠ¡è¯¢ç›˜æ±‡æ€»</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-table" style="display: none;">å±•å¼€</button>
                </div>
                <div class="filter-bar">
                    <label>å›¢é˜Ÿç­›é€‰ï¼š</label>
                    <select id="yw_team_filter" lay-filter="yw_team_filter" class="form-select" style="width: 150px;">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        {volist name="$data['yw_data']['total']" id='vo'}
                        <option value="{$vo['team_name']}">{$vo['team_name']}</option>
                        {/volist}
                    </select>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yw_data']['list']|array_column='yw_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body table-scroll" style="max-height: 400px; overflow-y: auto;">
                    <table id="yw_list_table" class="wukong-table fold-table">
                        <thead>
                            <tr>
                                <th>ä¸šåŠ¡å‘˜</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yw_data']['list']" id='vo'}
                            <tr>
                                <td><strong>{$vo['username']}</strong> ({$vo['team_name']})</td>
                                <td>{$vo['yw_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">ä¸šåŠ¡è¯¢ç›˜æ±‡æ€»</div>
                <div class="filter-bar">
                    <div><a href="javascript:void(0);" class="detail-link text-primary text-decoration-none" data-url="{:url('getDetail')}" data-type="yw-total">æŸ¥çœ‹è¯¦æƒ…</a></div>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yw_data']['total']|array_column='yw_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="yw_total_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>å›¢é˜Ÿ</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yw_data']['total']" id='vo' key="k" }
                            <tr>
                                <td><strong>{$vo['team_name']}</strong></td>
                                <td>{$vo['yw_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card fold-card export">
                <div class="wukong-table-card-header">
                    <span>è¿è¥è¯¢ç›˜æ±‡æ€»</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-table" style="display: none;">å±•å¼€</button>
                </div>
                <div class="filter-bar">
                    <label>å›¢é˜Ÿç­›é€‰ï¼š</label>
                    <select id="yy_team_filter" lay-filter="yy_team_filter" class="form-select" style="width: 150px;">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        {volist name="$data['yy_data']['total']" id='vo'}
                        <option value="{$vo['team_name']}">{$vo['team_name']}</option>
                        {/volist}
                    </select>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yy_data']['list']|array_column='yy_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body table-scroll" style="max-height: 400px; overflow-y: auto;">
                    <table id="yy_list_table" class="wukong-table fold-table">
                        <thead>
                            <tr>
                                <th>è¿è¥</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yy_data']['list']" id='vo'}
                            <tr>
                                <td><strong>{$vo['username']}</strong> ({$vo['channel']})</td>
                                <td>{$vo['yy_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">è¿è¥è¯¢ç›˜æ±‡æ€»</div>
                <div class="filter-bar">
                    <div class="total">åˆè®¡ï¼š<span>{$data['yy_data']['total']|array_column='yy_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="yy_total_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>å›¢é˜Ÿ</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yy_data']['total']" id='vo'}
                            <tr>
                                <td><strong>{$vo['team_name']}</strong></td>
                                <td>{$vo['yy_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">é”€å”®äº§å“æ±‡æ€»</div>
                <div class="wukong-table-card-body">
                    <table id="sp_list_table" class="wukong-table" data-url="getProdAll" data-params='{"data":{"type":"order"},"ele":["#at_time","#dateRange"]}'>
                        <thead>
                            <tr>
                                <th>äº§å“</th>
                                <th>é”€å”®æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod']}<tr>
                                <td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">è¯¢ç›˜äº§å“æ±‡æ€»</div>
                <div class="wukong-table-card-body">
                    <table id="pd_list_table" class="wukong-table" data-url="getProdAll" data-params='{"data":{"type":"oper"},"ele":["#at_time","#dateRange"]}'>
                        <thead>
                            <tr>
                                <th>äº§å“</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['oper_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod']}<tr>
                                <td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-12">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">æ€»è¯¢ç›˜ç»Ÿè®¡</div>
                <div class="filter-bar">
                    <div class="total">åˆè®¡ï¼š<span>{$data['total_inquiry_stats']|array_column='count'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="total_inquiry_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>æ¸ é“</th>
                                <th>ç«¯å£</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['total_inquiry_stats']" id='vo'}
                            <tr>
                                <td>{$vo['channel_name']}</td>
                                <td>{$vo['port_name'] ? $vo['port_name'] : '-'}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['total_inquiry_stats']}<tr>
                                <td colspan="3" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³è¾¹å¾…åŠ + åŠ¨æ€ -->
<div class="col-md-4">
    <div class="wukong-todo-card">
        <div class="wukong-todo-card-header">{$wenhou}</div>
        <div class="wukong-todo-card-body">
            <p class="mb-0">æ¬¢è¿å›æ¥ï¼ç¥ä½ å·¥ä½œé¡ºåˆ© ğŸ‘</p>
        </div>
    </div>

    <div class="wukong-table-card">
        <div class="wukong-table-card-header">å¾…åŠäº‹é¡¹</div>
        <div class="wukong-table-card-body">
            <table class="wukong-table">
                <tbody>
                    <tr>
                        <td><strong>ä»Šæ—¥å·²è·Ÿè¿›</strong></td>
                        <td class="text-primary"><strong>{$today_count}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>æœªè·Ÿè¿›ä¸ªæ•°</strong></td>
                        <td class="text-warning"><strong>{$all_count}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>è·Ÿè¿›ç‡</strong></td>
                        <td class="text-success"><strong>{$genjinlv}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="wukong-table-card">
        <div class="wukong-table-card-header">æœ€è¿‘åŠ¨æ€</div>
        <div class="wukong-table-card-body">
            <ul class="wukong-timeline">
                {volist name='result' id='vo'}
                <li class="wukong-timeline-item">
                    <img src="{$vo.avatar}" class="wukong-timeline-avatar" alt="{$vo.username}">
                    <div class="wukong-timeline-content">
                        <p>
                            <span class="wukong-timeline-username">{$vo.username}</span>
                            <span class="wukong-timeline-action">è·Ÿè¿›</span>
                            <a href="{:url('Client/dialogue')}?id={$vo.id}" class="wukong-timeline-link">{$vo.kh_name}</a>
                        </p>
                        <p class="wukong-timeline-msg">
                            <strong style="color: #d4a574;">è®°å½•:</strong> {$vo.reply_msg}
                        </p>
                        <span class="wukong-timeline-time">æ—¶é—´ï¼š{$vo.create_date|date='Y-m-d H:i:s'}</span>
                    </div>
                </li>
                {/volist}
            </ul>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…å¼¹çª— -->
<div id="detailModal" style="display: none; padding: 20px;">
    <div class="row">
        <div class="col-12">
            <div class="wukong-table-card">
                <div class="wukong-table-card-header">
                    <span id="modalTitle">äº¤å‰ç»Ÿè®¡è¡¨</span>
                    <button class="btn btn-sm btn-primary wukong-btn wukong-btn-primary" onclick="exportCrossTable()">å¯¼å‡ºè¡¨æ ¼</button>
                </div>
                <div class="wukong-table-card-body">
                    <div id="crossTableContainer" style="overflow-x: auto;">
                        <!-- è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨å¼¹çª— -->
<div id="performanceModal" style="display: none; padding: 20px;">
    <div class="wukong-table-card">
        <div class="wukong-table-card-header">
            <span>ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨</span>
        </div>
        <div class="filter-bar" style="padding: 15px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; white-space: nowrap;">ä¸šåŠ¡å‘˜ç­›é€‰ï¼š</label>
                <select id="performanceUserFilter" class="form-select" style="width: 200px;">
                    <option value="">å…¨éƒ¨ä¸šåŠ¡å‘˜</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; white-space: nowrap;">æ—¶é—´ç­›é€‰ï¼š</label>
                <select id="performanceTimeFilter" class="form-select" style="width: 150px;">
                    <option value="today">ä»Šå¤©</option>
                    <option value="yesterday">æ˜¨å¤©</option>
                    <option value="week">æœ¬å‘¨</option>
                    <option value="month" selected>æœ¬æœˆ</option>
                    <option value="year">æœ¬å¹´</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div id="performanceCustomTimeRange" style="display: none; gap: 8px; align-items: center;">
                <input type="date" id="performanceStartDate" class="form-control" style="width: 150px;">
                <span>è‡³</span>
                <input type="date" id="performanceEndDate" class="form-control" style="width: 150px;">
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="performanceFilterBtn" style="margin-left: auto;">
                <i class="bi bi-search"></i> ç­›é€‰
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="performanceResetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
            </button>
        </div>
        <div class="wukong-table-card-body">
            <div style="overflow-x: auto;">
                <table id="performanceTable" class="wukong-table">
                    <thead>
                        <tr>
                            <th data-sort="rank" style="cursor: pointer; user-select: none;">
                                æ’å <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="username" style="cursor: pointer; user-select: none;">
                                ä¸šåŠ¡å‘˜å§“å <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="team_name" style="cursor: pointer; user-select: none;">
                                æ‰€å±å›¢é˜Ÿ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="profit" style="cursor: pointer; user-select: none;">
                                åˆ©æ¶¦ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="profit_rate" style="cursor: pointer; user-select: none;">
                                åˆ©æ¶¦ç‡ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="performanceTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script>
    function initFoldCard() {
        $('.fold-card').each(function () {
            var $card = $(this);
            var $header = $card.find('.wukong-table-card-header');
            var $scroll = $card.find('.table-scroll');
            if ($scroll.length && $scroll[0].scrollHeight > $scroll.height() + 20) {
                var $toggleBtn = $header.find('.toggle-table');
                if ($toggleBtn.length === 0) {
                    $header.append('<button class="btn btn-sm btn-outline-secondary toggle-table">å±•å¼€</button>');
                } else {
                    $toggleBtn.show();
                }
            } else {
                $header.find('.toggle-table').hide();
            }
        });
    }
    // é¡µé¢åˆå§‹åŒ–æ—¶è¿è¡Œä¸€æ¬¡
    $(document).ready(function() {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
        setTimeout(function() {
            initFoldCard();
            if (typeof ExportSelectTables !== 'undefined') {
                ExportSelectTables.addCheckboxes();
            }
        }, 100);
        
        // å»¶è¿ŸåŠ è½½éå…³é”®æ•°æ®ï¼Œæå‡é¦–å±åŠ è½½é€Ÿåº¦
        setTimeout(function() {
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½ä¸€äº›éå…³é”®çš„æ•°æ®
        }, 500);
    });

    function init(){
        initFoldCard();
        if (typeof ExportSelectTables !== 'undefined') {
            ExportSelectTables.addCheckboxes();
        }
    }

    // æ˜¾ç¤ºä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨
    $('#showPerformanceBtn').on('click', function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        var loading = layer.load(2, {
            time: 30*1000, // å¢åŠ è¶…æ—¶æ—¶é—´
            
        });
        
        // è·å–å½“å‰æ—¶é—´ç­›é€‰å‚æ•°ï¼ˆä»çˆ¶é¡µé¢çš„è¡¨å•ä¸­è·å–ï¼‰
        var timebucket = '';
        var at_time = '';
        
        // ä»çˆ¶é¡µé¢çš„è¡¨å•ä¸­è·å–æ—¶é—´å‚æ•°
        var $timebucketSelect = $('#searchForm select[name="timebucket"], #dateRange, select[name="timebucket"]');
        var $atTimeInput = $('#searchForm input[name="at_time"], #at_time');
        
        if ($timebucketSelect.length) {
            timebucket = $timebucketSelect.val() || '';
        }
        if ($atTimeInput.length) {
            at_time = $atTimeInput.val() || '';
        }
        
        // å¦‚æœéƒ½æ²¡æœ‰è·å–åˆ°æ—¶é—´å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨æœ¬æœˆ
        if (!timebucket && !at_time) {
            timebucket = 'month';
        }
        
        // è°ƒç”¨åç«¯æ¥å£è·å–ä¸šç»©æ•°æ®
        $.ajax({
            url: '{:url("Operator/getPerformanceData")}',
            type: 'POST',
            data: {
                timebucket: timebucket,
                at_time: at_time
            },
            dataType: 'json',
            timeout: 30000, // 30ç§’è¶…æ—¶
            success: function(res) {
                layer.close(loading);
                $btn.prop('disabled', false).html(originalText);
                
                if (res.code === 0 || res.code === 200) {
                    // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºæ’åºå’Œç­›é€‰
                    window.performanceTableData = res.data || [];
                    window.performanceAllData = res.data || []; // ä¿å­˜å…¨éƒ¨æ•°æ®ç”¨äºé‡ç½®
                    
                    // å¡«å……ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
                    fillPerformanceUserFilter(window.performanceAllData);
                    
                    // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                    renderPerformanceTable(window.performanceTableData);
                    
                    // æ˜¾ç¤ºå¼¹çª—ï¼Œè®¾ç½®æœ€é«˜å±‚çº§
                    var layerIndex = layer.open({
                        type: 1,
                        title: 'ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨',
                        area: ['90%', '80%'],
                        content: $('#performanceModal'),
                        zIndex: 20000000, // è®¾ç½®éå¸¸é«˜çš„ z-index ç¡®ä¿åœ¨æœ€é¡¶å±‚
                        maxmin: true,
                        success: function(layero, index) {
                            // ç¡®ä¿å¼¹çª—åœ¨æœ€é¡¶å±‚
                            layero.css('z-index', 20000000);
                            // ç¡®ä¿é®ç½©å±‚ä¹Ÿåœ¨æœ€ä¸Šå±‚
                            $('.layui-layer-shade').css('z-index', 19999999);
                            $('#performanceModal').show();
                            
                            // ç»‘å®šè¡¨å¤´æ’åºäº‹ä»¶
                            bindTableSort();
                            
                            // ç»‘å®šç­›é€‰äº‹ä»¶
                            bindPerformanceFilter();
                        },
                        end: function() {
                            $('#performanceModal').hide();
                        }
                    });
                } else {
                    layer.msg(res.msg || 'è·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loading);
                $btn.prop('disabled', false).html(originalText);
                
                if (status === 'timeout') {
                    layer.msg('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                } else {
                    layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            }
        });
    });
    
    // æ¸²æŸ“ä¸šç»©è¡¨æ ¼
    function renderPerformanceTable(data) {
        var tbody = $('#performanceTableBody');
        tbody.empty();
        
        if (data && data.length > 0) {
            $.each(data, function(index, item) {
                var row = '<tr>' +
                    '<td>' + (item.rank || (index + 1)) + '</td>' +
                    '<td>' + (item.username || '') + '</td>' +
                    '<td>' + (item.team_name || '') + '</td>' +
                    '<td>' + (item.profit || '0.00') + '</td>' +
                    '<td>' + (item.profit_rate || '0.00') + '%</td>' +
                    '</tr>';
                tbody.append(row);
            });
        } else {
            tbody.append('<tr><td colspan="5" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>');
        }
    }
    
    // ç»‘å®šè¡¨å¤´æ’åºåŠŸèƒ½
    function bindTableSort() {
        var currentSort = {
            field: 'profit',
            order: 'desc' // desc: é™åº, asc: å‡åº
        };
        
        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons(field, order) {
            $('#performanceTable thead th').each(function() {
                var $th = $(this);
                var $icon = $th.find('.sort-icon');
                var sortField = $th.data('sort');
                
                if (sortField === field) {
                    if (order === 'desc') {
                        $icon.removeClass('bi-arrow-down bi-arrow-up bi-arrow-down-up')
                            .addClass('bi-arrow-down');
                    } else {
                        $icon.removeClass('bi-arrow-down bi-arrow-up bi-arrow-down-up')
                            .addClass('bi-arrow-up');
                    }
                } else {
                    $icon.removeClass('bi-arrow-down bi-arrow-up')
                        .addClass('bi-arrow-down-up');
                }
            });
        }
        
        // æ’åºå‡½æ•°
        function sortTable(field, order) {
            if (!window.performanceTableData || window.performanceTableData.length === 0) {
                return;
            }
            
            var data = window.performanceTableData.slice(); // å¤åˆ¶æ•°ç»„
            
            data.sort(function(a, b) {
                var aVal, bVal;
                
                // æ ¹æ®å­—æ®µè·å–å€¼
                switch(field) {
                    case 'rank':
                        aVal = parseInt(a.rank || 0);
                        bVal = parseInt(b.rank || 0);
                        break;
                    case 'username':
                        aVal = (a.username || '').toLowerCase();
                        bVal = (b.username || '').toLowerCase();
                        break;
                    case 'team_name':
                        aVal = (a.team_name || '').toLowerCase();
                        bVal = (b.team_name || '').toLowerCase();
                        break;
                    case 'profit':
                        aVal = parseFloat(a.profit || 0);
                        bVal = parseFloat(b.profit || 0);
                        break;
                    case 'profit_rate':
                        aVal = parseFloat(a.profit_rate || 0);
                        bVal = parseFloat(b.profit_rate || 0);
                        break;
                    default:
                        return 0;
                }
                
                // æ¯”è¾ƒå€¼
                if (typeof aVal === 'string') {
                    if (order === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                } else {
                    if (order === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                }
            });
            
            // é‡æ–°è®¡ç®—æ’å
            if (field === 'rank') {
                // å¦‚æœæŒ‰æ’åæ’åºï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—
            } else {
                // å…¶ä»–æ’åºéœ€è¦é‡æ–°è®¡ç®—æ’å
                $.each(data, function(index, item) {
                    item.rank = index + 1;
                });
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderPerformanceTable(data);
            updateSortIcons(field, order);
        }
        
        // ç»‘å®šè¡¨å¤´ç‚¹å‡»äº‹ä»¶
        $('#performanceTable thead th[data-sort]').off('click').on('click', function() {
            var $th = $(this);
            var field = $th.data('sort');
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºå­—æ®µï¼Œåˆ‡æ¢æ’åºæ–¹å‘
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'desc'; // é»˜è®¤é™åº
            }
            
            sortTable(currentSort.field, currentSort.order);
        });
        
        // åˆå§‹åŒ–æ’åºå›¾æ ‡
        updateSortIcons(currentSort.field, currentSort.order);
    }
    
    // å¡«å……ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
    function fillPerformanceUserFilter(data) {
        var $select = $('#performanceUserFilter');
        $select.empty();
        $select.append('<option value="">å…¨éƒ¨ä¸šåŠ¡å‘˜</option>');
        
        if (data && data.length > 0) {
            // è·å–æ‰€æœ‰å”¯ä¸€çš„ä¸šåŠ¡å‘˜
            var users = [];
            var userMap = {};
            $.each(data, function(index, item) {
                if (item.username && !userMap[item.username]) {
                    userMap[item.username] = true;
                    users.push({
                        username: item.username,
                        team_name: item.team_name || ''
                    });
                }
            });
            
            // æŒ‰å›¢é˜Ÿå’Œå§“åæ’åº
            users.sort(function(a, b) {
                if (a.team_name !== b.team_name) {
                    return (a.team_name || '').localeCompare(b.team_name || '');
                }
                return (a.username || '').localeCompare(b.username || '');
            });
            
            // å¡«å……ä¸‹æ‹‰æ¡†
            $.each(users, function(index, user) {
                var displayName = user.username;
                if (user.team_name) {
                    displayName += ' (' + user.team_name + ')';
                }
                $select.append('<option value="' + user.username + '">' + displayName + '</option>');
            });
        }
    }
    
    // ç»‘å®šç­›é€‰åŠŸèƒ½
    function bindPerformanceFilter() {
        // æ—¶é—´ç­›é€‰ä¸‹æ‹‰æ¡†å˜åŒ–
        $('#performanceTimeFilter').off('change').on('change', function() {
            var value = $(this).val();
            if (value === 'custom') {
                $('#performanceCustomTimeRange').css('display', 'flex');
            } else {
                $('#performanceCustomTimeRange').css('display', 'none');
            }
        });
        
        // ç­›é€‰æŒ‰é’®ç‚¹å‡»
        $('#performanceFilterBtn').off('click').on('click', function() {
            filterPerformanceTable();
        });
        
        // é‡ç½®æŒ‰é’®ç‚¹å‡»
        $('#performanceResetBtn').off('click').on('click', function() {
            resetPerformanceFilter();
        });
        
        // å›è½¦é”®è§¦å‘ç­›é€‰
        $('#performanceUserFilter, #performanceTimeFilter, #performanceStartDate, #performanceEndDate').off('keypress').on('keypress', function(e) {
            if (e.which === 13) {
                filterPerformanceTable();
            }
        });
    }
    
    // ç­›é€‰è¡¨æ ¼
    function filterPerformanceTable() {
        var selectedUser = $('#performanceUserFilter').val();
        var timeFilter = $('#performanceTimeFilter').val();
        var startDate = $('#performanceStartDate').val();
        var endDate = $('#performanceEndDate').val();
        
        // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰æ—¶é—´æˆ–æ—¶é—´ç­›é€‰æ”¹å˜ï¼Œéœ€è¦é‡æ–°è¯·æ±‚æ•°æ®
        if (timeFilter === 'custom' && startDate && endDate) {
            // ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´èŒƒå›´é‡æ–°è¯·æ±‚æ•°æ®
            loadPerformanceData(selectedUser, '', startDate + ',' + endDate);
        } else if (timeFilter && timeFilter !== 'custom') {
            // ä½¿ç”¨é¢„è®¾æ—¶é—´èŒƒå›´é‡æ–°è¯·æ±‚æ•°æ®
            loadPerformanceData(selectedUser, timeFilter, '');
        } else {
            // åªåšå‰ç«¯ç­›é€‰ï¼ˆä¸šåŠ¡å‘˜ç­›é€‰ï¼‰- æ˜¾ç¤ºåŠ è½½æç¤º
            var loading = layer.load(2, {
                time: 5000,
                content: '<div style="padding: 20px; text-align: center;"><i class="bi bi-hourglass-split" style="font-size: 24px;"></i><br><br>æ­£åœ¨ç­›é€‰æ•°æ®...</div>'
            });
            
            // ä½¿ç”¨ setTimeout è®© UI æœ‰æ—¶é—´æ˜¾ç¤ºåŠ è½½æç¤º
            setTimeout(function() {
                var filteredData = window.performanceAllData || [];
                
                if (selectedUser) {
                    filteredData = filteredData.filter(function(item) {
                        return item.username === selectedUser;
                    });
                }
                
                window.performanceTableData = filteredData;
                renderPerformanceTable(filteredData);
                
                // é‡æ–°è®¡ç®—æ’å
                $.each(window.performanceTableData, function(index, item) {
                    item.rank = index + 1;
                });
                
                // æ›´æ–°æ’åºå›¾æ ‡
                if (window.performanceTableData.length > 0) {
                    bindTableSort();
                }
                
                layer.close(loading);
            }, 50); // 50ms å»¶è¿Ÿï¼Œç¡®ä¿åŠ è½½æç¤ºæ˜¾ç¤º
        }
    }
    
    // é‡ç½®ç­›é€‰
    function resetPerformanceFilter() {
        $('#performanceUserFilter').val('');
        $('#performanceTimeFilter').val('month');
        $('#performanceCustomTimeRange').css('display', 'none');
        $('#performanceStartDate').val('');
        $('#performanceEndDate').val('');
        
        // é‡æ–°åŠ è½½æ•°æ®ï¼ˆä½¿ç”¨é»˜è®¤æ—¶é—´ï¼‰
        loadPerformanceData('', 'month', '');
    }
    
    // åŠ è½½ä¸šç»©æ•°æ®
    function loadPerformanceData(username, timebucket, at_time) {
        // ç¦ç”¨ç­›é€‰æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        var $filterBtn = $('#performanceFilterBtn');
        var $resetBtn = $('#performanceResetBtn');
        var originalFilterText = $filterBtn.html();
        var originalResetText = $resetBtn.html();
        
        $filterBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');
        $resetBtn.prop('disabled', true);
        
        var loading = layer.load(2, {
            time: 30*1000,
          
        });
        
        $.ajax({
            url: '{:url("Operator/getPerformanceData")}',
            type: 'POST',
            data: {
                username: username,
                timebucket: timebucket,
                at_time: at_time
            },
            dataType: 'json',
            timeout: 30000,
            success: function(res) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);
                
                if (res.code === 0 || res.code === 200) {
                    window.performanceTableData = res.data || [];
                    window.performanceAllData = res.data || [];
                    
                    // æ›´æ–°ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
                    fillPerformanceUserFilter(window.performanceAllData);
                    
                    // å¦‚æœç­›é€‰äº†ä¸šåŠ¡å‘˜ï¼Œè®¾ç½®ä¸‹æ‹‰æ¡†å€¼
                    if (username) {
                        $('#performanceUserFilter').val(username);
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderPerformanceTable(window.performanceTableData);
                    
                    // é‡æ–°ç»‘å®šæ’åº
                    bindTableSort();
                } else {
                    layer.msg(res.msg || 'è·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);
                
                if (status === 'timeout') {
                    layer.msg('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                } else {
                    layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            }
        });
    }
</script>