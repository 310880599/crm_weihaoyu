<!-- å·¦è¾¹ç»Ÿè®¡ -->
 <style>
    .table-export-select{
        border: none !important;
    }
    /* éª¨æ¶å±æ ·å¼ */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row {
        height: 40px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    /* ä¸¤ä¸ªä¸šç»©æŒ‰é’®ï¼šæ’‘æ»¡åˆ— */
    .wukong-btn-per-user,
    .wukong-btn-per-team{
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 14px;
        border-radius: 10px;
        font-weight: 600;
    }

    /* å·¦ï¼šä¸šåŠ¡å‘˜ï¼ˆä¿æŒä½ åŸæœ¬ä¸»è‰²ä¹Ÿè¡Œï¼Œè¿™é‡Œç»™ä¸€ä¸ªæ›´é«˜çº§çš„è“ï¼‰ */
    .wukong-btn-per-user{
        background: linear-gradient(135deg, #2f7cf6, #1f5fd6);
        border: none;
        color: #fff;
    }

    /* å³ï¼šå›¢é˜Ÿï¼ˆæ¢æˆç»¿è‰²/é’è‰²ï¼Œæ˜æ˜¾åŒºåˆ†ï¼‰ */
    .wukong-btn-per-team{
        background: linear-gradient(135deg, #16a34a, #22c55e);
        border: none;
        color: #fff;
    }

    /* hover å¾®åŠ¨æ•ˆ */
    .wukong-btn-per-user:hover,
    .wukong-btn-per-team:hover{
        filter: brightness(1.03);
        transform: translateY(-1px);
        transition: all .15s ease;
    }

    /* === split-layout start === */
    /* åˆ†æ å¸ƒå±€æ ·å¼ */
    .split-wrap {
        display: flex;
        height: 100%;
        width: 100%;
    }
    .split-left, .split-mid, .split-right {
        transition: width 0.3s ease;
        overflow: hidden;
    }
    .split-left.hidden, .split-mid.hidden, .split-right.hidden {
        display: none !important;
    }
    .split-left.collapsed, .split-mid.collapsed, .split-right.collapsed {
        width: 64px !important;
        border: none !important;
    }
    /* collapsed çŠ¶æ€æ ·å¼ */
    .split-left.collapsed #teamPane,
    .split-mid.collapsed #memberPane,
    .split-right.collapsed #memberDetailPane {
        display: none !important;
    }
    .split-left.collapsed .pane-header,
    .split-mid.collapsed .pane-header,
    .split-right.collapsed .pane-header {
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 10px 5px !important;
        height: 100% !important;
    }
    .split-left.collapsed .pane-header > span,
    .split-mid.collapsed .pane-header > span,
    .split-right.collapsed .pane-header > span {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        margin-bottom: 10px;
    }
    .split-left.collapsed .pane-header > div,
    .split-mid.collapsed .pane-header > div,
    .split-right.collapsed .pane-header > div {
        display: flex !important;
        flex-direction: column !important;
        gap: 5px;
    }
    .split-left.maximized, .split-mid.maximized, .split-right.maximized {
        width: 100% !important;
    }
    /* ä¸šåŠ¡å‘˜åç§°å¯ç‚¹å‡»æ ·å¼ */
    .member-name-clickable {
        color: #4f7cff;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
    }
    .member-name-clickable:hover {
        color: #6fa1ff;
        text-decoration: underline;
    }
    .member-name-clickable.is-active {
        background-color: #e8f1ff;
        padding: 4px 8px;
        border-radius: 4px;
    }
    /* === split-layout end === */

 </style>
<div class="col-md-8">
    <!-- ä¸šç»©æŒ‰é’®ï¼šå·¦ä¸šåŠ¡å‘˜ï¼Œå³å›¢é˜Ÿ -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <button type="button" class="btn wukong-btn wukong-btn-primary wukong-btn-per-user" id="showPerformanceBtn">
                <i class="bi bi-bar-chart-line"></i> æŸ¥çœ‹ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨
            </button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn wukong-btn wukong-btn-primary wukong-btn-per-team" id="showTeamPerformanceBtn">
                <i class="bi bi-people-fill"></i> æŸ¥çœ‹å›¢é˜Ÿä¸šç»©è¡¨
            </button>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card fold-card export">
                <div class="wukong-table-card-header">
                    <span>ä¸šåŠ¡è¯¢ç›˜æ±‡æ€»</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-table" style="display: none;">å±•å¼€</button>
                </div>
                <div class="filter-bar">
                    <label>å›¢é˜Ÿç­›é€‰ï¼š</label>
                    <select id="yw_team_filter" lay-filter="yw_team_filter" class="form-select" style="width: 150px;">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        {volist name="$data['yw_data']['total']" id='vo'}
                        <option value="{$vo['team_name']}">{$vo['team_name']}</option>
                        {/volist}
                    </select>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yw_data']['list']|array_column='yw_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body table-scroll" style="max-height: 400px; overflow-y: auto;">
                    <table id="yw_list_table" class="wukong-table fold-table">
                        <thead>
                            <tr>
                                <th>ä¸šåŠ¡å‘˜</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yw_data']['list']" id='vo'}
                            <tr>
                                <td><strong>{$vo['username']}</strong> ({$vo['team_name']})</td>
                                <td>{$vo['yw_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">ä¸šåŠ¡è¯¢ç›˜æ±‡æ€»</div>
                <div class="filter-bar">
                    <div><a href="javascript:void(0);" class="detail-link text-primary text-decoration-none" data-url="{:url('getDetail')}" data-type="yw-total">æŸ¥çœ‹è¯¦æƒ…</a></div>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yw_data']['total']|array_column='yw_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="yw_total_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>å›¢é˜Ÿ</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yw_data']['total']" id='vo' key="k" }
                            <tr>
                                <td><strong>{$vo['team_name']}</strong></td>
                                <td>{$vo['yw_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card fold-card export">
                <div class="wukong-table-card-header">
                    <span>è¿è¥è¯¢ç›˜æ±‡æ€»</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-table" style="display: none;">å±•å¼€</button>
                </div>
                <div class="filter-bar">
                    <label>å›¢é˜Ÿç­›é€‰ï¼š</label>
                    <select id="yy_team_filter" lay-filter="yy_team_filter" class="form-select" style="width: 150px;">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        {volist name="$data['yy_data']['total']" id='vo'}
                        <option value="{$vo['team_name']}">{$vo['team_name']}</option>
                        {/volist}
                    </select>
                    <div class="total">åˆè®¡ï¼š<span>{$data['yy_data']['list']|array_column='yy_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body table-scroll" style="max-height: 400px; overflow-y: auto;">
                    <table id="yy_list_table" class="wukong-table fold-table">
                        <thead>
                            <tr>
                                <th>è¿è¥</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yy_data']['list']" id='vo'}
                            <tr>
                                <td><strong>{$vo['username']}</strong> ({$vo['channel']})</td>
                                <td>{$vo['yy_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">è¿è¥è¯¢ç›˜æ±‡æ€»</div>
                <div class="filter-bar">
                    <div class="total">åˆè®¡ï¼š<span>{$data['yy_data']['total']|array_column='yy_num'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="yy_total_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>å›¢é˜Ÿ</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['yy_data']['total']" id='vo'}
                            <tr>
                                <td><strong>{$vo['team_name']}</strong></td>
                                <td>{$vo['yy_num']}</td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">é”€å”®äº§å“æ±‡æ€»</div>
                <div class="wukong-table-card-body">
                    <table id="sp_list_table" class="wukong-table" data-url="getProdAll" data-params='{"data":{"type":"order"},"ele":["#at_time","#dateRange"]}'>
                        <thead>
                            <tr>
                                <th>äº§å“</th>
                                <th>é”€å”®æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod']}<tr>
                                <td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">è¯¢ç›˜äº§å“æ±‡æ€»</div>
                <div class="wukong-table-card-body">
                    <table id="pd_list_table" class="wukong-table" data-url="getProdAll" data-params='{"data":{"type":"oper"},"ele":["#at_time","#dateRange"]}'>
                        <thead>
                            <tr>
                                <th>äº§å“</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['oper_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod']}<tr>
                                <td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-12">
            <div class="wukong-table-card export">
                <div class="wukong-table-card-header">æ€»è¯¢ç›˜ç»Ÿè®¡</div>
                <div class="filter-bar">
                    <div class="total">åˆè®¡ï¼š<span>{$data['total_inquiry_stats']|array_column='count'|array_sum}</span></div>
                </div>
                <div class="wukong-table-card-body">
                    <table id="total_inquiry_table" class="wukong-table">
                        <thead>
                            <tr>
                                <th>æ¸ é“</th>
                                <th>ç«¯å£</th>
                                <th>è¯¢ç›˜æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['total_inquiry_stats']" id='vo'}
                            <tr>
                                <td>{$vo['channel_name']}</td>
                                <td>{$vo['port_name'] ? $vo['port_name'] : '-'}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['total_inquiry_stats']}<tr>
                                <td colspan="3" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³è¾¹å¾…åŠ + åŠ¨æ€ -->
<div class="col-md-4">
    <div class="wukong-todo-card">
        <div class="wukong-todo-card-header">{$wenhou}</div>
        <div class="wukong-todo-card-body">
            <p class="mb-0">æ¬¢è¿å›æ¥ï¼ç¥ä½ å·¥ä½œé¡ºåˆ© ğŸ‘</p>
        </div>
    </div>

    <div class="wukong-table-card">
        <div class="wukong-table-card-header">å¾…åŠäº‹é¡¹</div>
        <div class="wukong-table-card-body">
            <table class="wukong-table">
                <tbody>
                    <tr>
                        <td><strong>ä»Šæ—¥å·²è·Ÿè¿›</strong></td>
                        <td class="text-primary"><strong>{$today_count}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>æœªè·Ÿè¿›ä¸ªæ•°</strong></td>
                        <td class="text-warning"><strong>{$all_count}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>è·Ÿè¿›ç‡</strong></td>
                        <td class="text-success"><strong>{$genjinlv}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="wukong-table-card">
        <div class="wukong-table-card-header">æœ€è¿‘åŠ¨æ€</div>
        <div class="wukong-table-card-body">
            <ul class="wukong-timeline">
                {volist name='result' id='vo'}
                <li class="wukong-timeline-item">
                    <img src="{$vo.avatar}" class="wukong-timeline-avatar" alt="{$vo.username}">
                    <div class="wukong-timeline-content">
                        <p>
                            <span class="wukong-timeline-username">{$vo.username}</span>
                            <span class="wukong-timeline-action">è·Ÿè¿›</span>
                            <a href="{:url('Client/dialogue')}?id={$vo.id}" class="wukong-timeline-link">{$vo.kh_name}</a>
                        </p>
                        <p class="wukong-timeline-msg">
                            <strong style="color: #d4a574;">è®°å½•:</strong> {$vo.reply_msg}
                        </p>
                        <span class="wukong-timeline-time">æ—¶é—´ï¼š{$vo.create_date|date='Y-m-d H:i:s'}</span>
                    </div>
                </li>
                {/volist}
            </ul>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…å¼¹çª— -->
<div id="detailModal" style="display: none; padding: 20px;">
    <div class="row">
        <div class="col-12">
            <div class="wukong-table-card">
                <div class="wukong-table-card-header">
                    <span id="modalTitle">äº¤å‰ç»Ÿè®¡è¡¨</span>
                    <button class="btn btn-sm btn-primary wukong-btn wukong-btn-primary" onclick="exportCrossTable()">å¯¼å‡ºè¡¨æ ¼</button>
                </div>
                <div class="wukong-table-card-body">
                    <div id="crossTableContainer" style="overflow-x: auto;">
                        <!-- è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨å¼¹çª— -->
<div id="performanceModal" style="display: none; padding: 20px;">
    <div class="wukong-table-card">
        <div class="wukong-table-card-header">
            <span>ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨</span>
        </div>
        <div class="filter-bar" style="padding: 15px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; white-space: nowrap;">ä¸šåŠ¡å‘˜ç­›é€‰ï¼š</label>
                <select id="performanceUserFilter" class="form-select" style="width: 200px;">
                    <option value="">å…¨éƒ¨ä¸šåŠ¡å‘˜</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; white-space: nowrap;">æ—¶é—´ç­›é€‰ï¼š</label>
                <select id="performanceTimeFilter" class="form-select" style="width: 150px;">
                    <option value="today">ä»Šå¤©</option>
                    <option value="yesterday">æ˜¨å¤©</option>
                    <option value="week">æœ¬å‘¨</option>
                    <option value="month" selected>æœ¬æœˆ</option>
                    <option value="year">æœ¬å¹´</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div id="performanceCustomTimeRange" style="display: none; gap: 8px; align-items: center;">
                <input type="date" id="performanceStartDate" class="form-control" style="width: 150px;">
                <span>è‡³</span>
                <input type="date" id="performanceEndDate" class="form-control" style="width: 150px;">
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="performanceFilterBtn" style="margin-left: auto;">
                <i class="bi bi-search"></i> ç­›é€‰
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="performanceResetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
            </button>
        </div>
        <div class="wukong-table-card-body">
            <div style="overflow-x: auto;">
                <table id="performanceTable" class="wukong-table">
                    <thead>
                        <tr>
                            <th data-sort="rank" style="cursor: pointer; user-select: none;">
                                æ’å <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="username" style="cursor: pointer; user-select: none;">
                                ä¸šåŠ¡å‘˜å§“å <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="team_name" style="cursor: pointer; user-select: none;">
                                æ‰€å±å›¢é˜Ÿ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="profit" style="cursor: pointer; user-select: none;">
                                åˆ©æ¶¦ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th data-sort="profit_rate" style="cursor: pointer; user-select: none;">
                                åˆ©æ¶¦ç‡ <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="performanceTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- ==========ã€æ–°å¢å¼€å§‹ï¼šå›¢é˜Ÿä¸šç»©è¡¨å¼¹çª—ã€‘========== -->
    {include file="operator/team_performance_table"/}
<!-- ==========ã€æ–°å¢ç»“æŸï¼šå›¢é˜Ÿä¸šç»©è¡¨å¼¹çª—ã€‘========== -->

<!-- === split-layout start === -->
<!-- å›¢é˜Ÿä¸šç»©åˆ†æ å¸ƒå±€å®¹å™¨ -->
<div id="teamPerformanceSplitLayout" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f6f8fb; z-index: 20000001;">
    <div class="split-wrap" style="display: flex; height: 100%; width: 100%; overflow: hidden;">
        <!-- å·¦åˆ—ï¼šå›¢é˜Ÿåˆ—è¡¨ -->
        <div class="split-left" style="width: 30%; background: #ffffff; border-right: 1px solid #e9ecef; display: flex; flex-direction: column; overflow: hidden;">
            <div class="pane-header" style="padding: 15px; background: linear-gradient(90deg, #4f7cff, #6fa1ff); color: #fff; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <span style="font-size: 16px; font-weight: 600;">ğŸ§© å›¢é˜Ÿåˆ—è¡¨</span>
                <div>
                    <button class="btn btn-sm btn-light" id="splitLeftMaximize" title="æœ€å¤§åŒ–/æ¢å¤">
                        <i class="bi bi-arrows-angle-expand"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="splitLeftCollapse" title="æ”¶èµ·/å±•å¼€">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="splitLayoutClose" title="å…³é—­" style="margin-left: 8px;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div id="teamPane" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- å›¢é˜Ÿåˆ—è¡¨å†…å®¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
            </div>
        </div>
        
        <!-- ä¸­åˆ—ï¼šæˆå‘˜æ’å -->
        <div class="split-mid" style="width: 35%; background: #ffffff; border-right: 1px solid #e9ecef; display: flex; flex-direction: column; overflow: hidden;">
            <div class="pane-header" style="padding: 15px; background: linear-gradient(90deg, #4f7cff, #6fa1ff); color: #fff; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <span style="font-size: 16px; font-weight: 600;" id="memberPaneTitle">ğŸ‘¥ æˆå‘˜ä¸šç»©æ’å</span>
                <div>
                    <button class="btn btn-sm btn-light" id="splitMidRefresh" title="åˆ·æ–°">
                        <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
                    </button>
                    <button class="btn btn-sm btn-light" id="splitMidMaximize" title="æœ€å¤§åŒ–/æ¢å¤">
                        <i class="bi bi-arrows-angle-expand"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="splitMidCollapse" title="æ”¶èµ·/å±•å¼€">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div id="memberPane" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                    <p style="font-size: 16px; margin: 0;">è¯·é€‰æ‹©å›¢é˜ŸæŸ¥çœ‹æˆå‘˜ä¸šç»©æ’å</p>
                </div>
            </div>
        </div>
        
        <!-- å³åˆ—ï¼šä¸ªäººä¸šç»©æ¸…å• -->
        <div class="split-right" style="width: 35%; background: #ffffff; display: flex; flex-direction: column; overflow: hidden;">
            <div class="pane-header" style="padding: 15px; background: linear-gradient(90deg, #4f7cff, #6fa1ff); color: #fff; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <span style="font-size: 16px; font-weight: 600;" id="memberDetailPaneTitle">ğŸ“‹ ä¸ªäººä¸šç»©æ¸…å•</span>
                <div>
                    <button class="btn btn-sm btn-light" id="splitRightRefresh" title="åˆ·æ–°">
                        <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
                    </button>
                    <button class="btn btn-sm btn-light" id="splitRightMaximize" title="æœ€å¤§åŒ–/æ¢å¤">
                        <i class="bi bi-arrows-angle-expand"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="splitRightCollapse" title="æ”¶èµ·/å±•å¼€">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div id="memberDetailPane" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                    <p style="font-size: 16px; margin: 0;">è¯·ç‚¹å‡»ä¸šåŠ¡å‘˜åç§°æŸ¥çœ‹ä¸ªäººä¸šç»©æ¸…å•</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- === split-layout end === -->


<script>
    function initFoldCard() {
        $('.fold-card').each(function () {
            var $card = $(this);
            var $header = $card.find('.wukong-table-card-header');
            var $scroll = $card.find('.table-scroll');
            if ($scroll.length && $scroll[0].scrollHeight > $scroll.height() + 20) {
                var $toggleBtn = $header.find('.toggle-table');
                if ($toggleBtn.length === 0) {
                    $header.append('<button class="btn btn-sm btn-outline-secondary toggle-table">å±•å¼€</button>');
                } else {
                    $toggleBtn.show();
                }
            } else {
                $header.find('.toggle-table').hide();
            }
        });
    }
    // é¡µé¢åˆå§‹åŒ–æ—¶è¿è¡Œä¸€æ¬¡
    $(document).ready(function() {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
        setTimeout(function() {
            initFoldCard();
            if (typeof ExportSelectTables !== 'undefined') {
                ExportSelectTables.addCheckboxes();
            }
        }, 100);
        
        // å»¶è¿ŸåŠ è½½éå…³é”®æ•°æ®ï¼Œæå‡é¦–å±åŠ è½½é€Ÿåº¦
        setTimeout(function() {
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½ä¸€äº›éå…³é”®çš„æ•°æ®
        }, 500);
    });

    function init(){
        initFoldCard();
        if (typeof ExportSelectTables !== 'undefined') {
            ExportSelectTables.addCheckboxes();
        }
    }

    // æ˜¾ç¤ºä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨
    $('#showPerformanceBtn').on('click', function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        var loading = layer.load(2, {
            time: 30*1000, // å¢åŠ è¶…æ—¶æ—¶é—´
            
        });
        
        // è·å–å½“å‰æ—¶é—´ç­›é€‰å‚æ•°ï¼ˆä»çˆ¶é¡µé¢çš„è¡¨å•ä¸­è·å–ï¼‰
        var timebucket = '';
        var at_time = '';
        
        // ä»çˆ¶é¡µé¢çš„è¡¨å•ä¸­è·å–æ—¶é—´å‚æ•°
        var $timebucketSelect = $('#searchForm select[name="timebucket"], #dateRange, select[name="timebucket"]');
        var $atTimeInput = $('#searchForm input[name="at_time"], #at_time');
        
        if ($timebucketSelect.length) {
            timebucket = $timebucketSelect.val() || '';
        }
        if ($atTimeInput.length) {
            at_time = $atTimeInput.val() || '';
        }
        
        // å¦‚æœéƒ½æ²¡æœ‰è·å–åˆ°æ—¶é—´å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨æœ¬æœˆ
        if (!timebucket && !at_time) {
            timebucket = 'month';
        }
        
        // è°ƒç”¨åç«¯æ¥å£è·å–ä¸šç»©æ•°æ®
        $.ajax({
            url: '{:url("Operator/getPerformanceData")}',
            type: 'POST',
            data: {
                timebucket: timebucket,
                at_time: at_time
            },
            dataType: 'json',
            timeout: 30000, // 30ç§’è¶…æ—¶
            success: function(res) {
                layer.close(loading);
                $btn.prop('disabled', false).html(originalText);
                
                if (res.code === 0 || res.code === 200) {
                    // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºæ’åºå’Œç­›é€‰
                    window.performanceTableData = res.data || [];
                    window.performanceAllData = res.data || []; // ä¿å­˜å…¨éƒ¨æ•°æ®ç”¨äºé‡ç½®
                    
                    // å¡«å……ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
                    fillPerformanceUserFilter(window.performanceAllData);
                    
                    // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                    renderPerformanceTable(window.performanceTableData);
                    
                    // æ˜¾ç¤ºå¼¹çª—ï¼Œè®¾ç½®æœ€é«˜å±‚çº§
                    var layerIndex = layer.open({
                        type: 1,
                        title: 'ä¸šåŠ¡äººå‘˜ä¸šç»©è¡¨',
                        area: ['90%', '80%'],
                        content: $('#performanceModal'),
                        zIndex: 20000000, // è®¾ç½®éå¸¸é«˜çš„ z-index ç¡®ä¿åœ¨æœ€é¡¶å±‚
                        maxmin: true,
                        success: function(layero, index) {
                            // ç¡®ä¿å¼¹çª—åœ¨æœ€é¡¶å±‚
                            layero.css('z-index', 20000000);
                            // ç¡®ä¿é®ç½©å±‚ä¹Ÿåœ¨æœ€ä¸Šå±‚
                            $('.layui-layer-shade').css('z-index', 19999999);
                            $('#performanceModal').show();
                            
                            // ç»‘å®šè¡¨å¤´æ’åºäº‹ä»¶
                            bindTableSort();
                            
                            // ç»‘å®šç­›é€‰äº‹ä»¶
                            bindPerformanceFilter();
                        },
                        end: function() {
                            $('#performanceModal').hide();
                        }
                    });
                } else {
                    layer.msg(res.msg || 'è·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loading);
                $btn.prop('disabled', false).html(originalText);
                
                if (status === 'timeout') {
                    layer.msg('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                } else {
                    layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            }
        });
    });


    // ==========ã€æ–°å¢å¼€å§‹ï¼šå›¢é˜Ÿä¸šç»©è¡¨ - ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºåˆ†æ å¸ƒå±€ã€‘==========

    // === split-layout start ===
    // æ˜¾ç¤ºå›¢é˜Ÿä¸šç»©è¡¨ï¼ˆåˆ†æ å¸ƒå±€ï¼‰
    $('#showTeamPerformanceBtn').off('click').on('click', function () {
        var $btn = $(this);
        var originalText = $btn.html();

        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');

        // loading
        var loading = layer.load(2, { time: 30 * 1000 });

        // é»˜è®¤æ—¶é—´ï¼šmonth
        var timebucket = 'month';
        var at_time = '';

        // åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºåˆ†æ å¸ƒå±€
        loadTeamPerformanceData(timebucket, at_time, function() {
            layer.close(loading);
            $btn.prop('disabled', false).html(originalText);

            // æ˜¾ç¤ºåˆ†æ å¸ƒå±€
            $('#teamPerformanceSplitLayout').show();
            
            // å°†å›¢é˜Ÿåˆ—è¡¨å†…å®¹æ¸²æŸ“åˆ°å·¦åˆ—
            renderTeamListToPane();
            
            // ç»‘å®šç­›é€‰äº‹ä»¶å’Œåˆ†æ æ§åˆ¶äº‹ä»¶
            bindTeamPerformanceEvents();
            bindSplitLayoutEvents();
        }, function() {
            layer.close(loading);
            $btn.prop('disabled', false).html(originalText);
        });
    });

    // å°†å›¢é˜Ÿåˆ—è¡¨æ¸²æŸ“åˆ°å·¦åˆ—å®¹å™¨
    function renderTeamListToPane() {
        var $teamPane = $('#teamPane');
        var $modal = $('#teamPerformanceModal');
        
        // å°†å¼¹çª—å†…å®¹ç§»åŠ¨åˆ°å·¦åˆ—ï¼ˆä½†ä¸æ˜¾ç¤ºå¼¹çª—ï¼‰
        if ($modal.length && $modal.find('.wukong-table-card').length) {
            var $card = $modal.find('.wukong-table-card').clone();
            // ç§»é™¤åˆ·æ–°æŒ‰é’®ï¼ˆå› ä¸ºå·²ç»åœ¨å¤´éƒ¨æœ‰äº†ï¼‰
            $card.find('#teamPerformanceRefresh').remove();
            $teamPane.empty().append($card);
            
            // é‡æ–°ç»‘å®šäº‹ä»¶ï¼ˆå› ä¸ºå…ƒç´ æ˜¯å…‹éš†çš„ï¼Œéœ€è¦é‡æ–°ç»‘å®šï¼‰
            setTimeout(function() {
                initTeamRowClick();
            }, 100);
        }
    }

    // ç»‘å®šåˆ†æ å¸ƒå±€æ§åˆ¶äº‹ä»¶
    function bindSplitLayoutEvents() {
        // å…³é—­åˆ†æ å¸ƒå±€ï¼ˆç‚¹å‡»é®ç½©æˆ–ESCé”®ï¼‰
        $(document).off('keydown.splitLayout').on('keydown.splitLayout', function(e) {
            if (e.keyCode === 27) { // ESCé”®
                $('#teamPerformanceSplitLayout').hide();
            }
        });

        // å·¦åˆ—æœ€å¤§åŒ–/æ¢å¤
        $('#splitLeftMaximize').off('click').on('click', function() {
            var $left = $('.split-left');
            var $mid = $('.split-mid');
            var $right = $('.split-right');
            if ($left.hasClass('maximized')) {
                $left.removeClass('maximized').css('width', '30%');
                $mid.removeClass('hidden').css('width', '35%');
                $right.css('width', '35%');
            } else {
                $left.addClass('maximized').css('width', '100%');
                $mid.addClass('hidden').css('width', '0');
                $right.css('width', '0');
            }
        });

        // å·¦åˆ—æ”¶èµ·/å±•å¼€
        $('#splitLeftCollapse').off('click').on('click', function() {
            var $left = $('.split-left');
            var $mid = $('.split-mid');
            var $right = $('.split-right');
            if ($left.hasClass('collapsed')) {
                $left.removeClass('collapsed').css('width', '30%');
                $mid.css('width', '35%');
                $right.css('width', '35%');
            } else {
                $left.addClass('collapsed').css('width', '64px');
                $mid.css('width', 'calc((100% - 64px) / 2)');
                $right.css('width', 'calc((100% - 64px) / 2)');
            }
        });

        // ä¸­åˆ—æœ€å¤§åŒ–/æ¢å¤
        $('#splitMidMaximize').off('click').on('click', function() {
            var $left = $('.split-left');
            var $mid = $('.split-mid');
            var $right = $('.split-right');
            if ($mid.hasClass('maximized')) {
                $mid.removeClass('maximized').css('width', '35%');
                $right.css('width', '35%');
                $left.removeClass('hidden').css('width', '30%');
            } else {
                $mid.addClass('maximized').css('width', '100%');
                $right.css('width', '0');
                $left.addClass('hidden').css('width', '0');
            }
        });

        // ä¸­åˆ—æ”¶èµ·/å±•å¼€
        $('#splitMidCollapse').off('click').on('click', function() {
            var $mid = $('.split-mid');
            var $right = $('.split-right');
            if ($mid.hasClass('collapsed')) {
                $mid.removeClass('collapsed').css('width', '35%');
                $right.css('width', '35%');
                $('.split-left').css('width', '30%');
            } else {
                $mid.addClass('collapsed').css('width', '64px');
                $right.css('width', 'calc(70% - 64px)');
                $('.split-left').css('width', '30%');
            }
        });
        
        // å³åˆ—æœ€å¤§åŒ–/æ¢å¤
        $('#splitRightMaximize').off('click').on('click', function() {
            var $right = $('.split-right');
            var $left = $('.split-left');
            var $mid = $('.split-mid');
            if ($right.hasClass('maximized')) {
                $right.removeClass('maximized').css('width', '35%');
                $left.removeClass('hidden').css('width', '30%');
                $mid.css('width', '35%');
            } else {
                $right.addClass('maximized').css('width', '100%');
                $left.addClass('hidden').css('width', '0');
                $mid.css('width', '0');
            }
        });
        
        // å³åˆ—æ”¶èµ·/å±•å¼€
        $('#splitRightCollapse').off('click').on('click', function() {
            var $right = $('.split-right');
            var $mid = $('.split-mid');
            if ($right.hasClass('collapsed')) {
                $right.removeClass('collapsed').css('width', '35%');
                $mid.css('width', '35%');
                $('.split-left').css('width', '30%');
            } else {
                $right.addClass('collapsed').css('width', '64px');
                $mid.css('width', 'calc(70% - 64px)');
                $('.split-left').css('width', '30%');
            }
        });
        
        // å³åˆ—åˆ·æ–°æŒ‰é’®
        $('#splitRightRefresh').off('click').on('click', function() {
            var $activeMember = $('.member-name-clickable.is-active');
            if ($activeMember.length > 0) {
                // è·å–ä¸šåŠ¡å‘˜åç§°ï¼šä¼˜å…ˆè¯»å–åŸå§‹å±æ€§å¹¶è¿›è¡Œè§£ç 
                var raw = $activeMember.attr('data-username') || $activeMember.text().trim();
                var username = raw;
                try { 
                    username = decodeURIComponent(raw); 
                } catch(e) { 
                    username = raw; 
                }
                username = (username || '').trim();
                
                if (window.TeamSplit && username) {
                    var timebucket = window.TeamSplit.lastTimebucket || 'month';
                    var at_time = window.TeamSplit.lastAtTime || '';
                    window.TeamSplit.renderMemberDetail(username, timebucket, at_time);
                }
            } else {
                layer.msg('è¯·å…ˆé€‰æ‹©ä¸šåŠ¡å‘˜', {icon: 2});
            }
        });

        // ä¸­åˆ—åˆ·æ–°æŒ‰é’®
        $('#splitMidRefresh').off('click').on('click', function() {
            if (window.TeamSplit && window.TeamSplit.lastTeamId) {
                var timeParams = getTeamTimeParams();
                if (!timeParams) {
                    // è‡ªå®šä¹‰æ—¶é—´æœªé€‰æ‹©å®Œæ•´ï¼Œä½¿ç”¨ä¿å­˜çš„æ—¶é—´å‚æ•°
                    timeParams = {
                        timebucket: window.TeamSplit.lastTimebucket || 'month',
                        at_time: window.TeamSplit.lastAtTime || ''
                    };
                }
                window.TeamSplit.renderMemberRank(window.TeamSplit.lastTeamId, window.TeamSplit.lastTeamName, timeParams.timebucket, timeParams.at_time);
            } else {
                layer.msg('è¯·å…ˆé€‰æ‹©å›¢é˜Ÿ', {icon: 2});
            }
        });

        // å…³é—­åˆ†æ å¸ƒå±€
        $('#splitLayoutClose').off('click').on('click', function() {
            $('#teamPerformanceSplitLayout').hide();
        });
    }
    // === split-layout end ===

    // åŠ è½½å›¢é˜Ÿä¸šç»©æ•°æ®
    function loadTeamPerformanceData(timebucket, at_time, successCallback, errorCallback) {
        // ç¦ç”¨ç­›é€‰/é‡ç½®æŒ‰é’®ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
        var $filterBtn = $('#teamPerformanceFilterBtn, #teamPane #teamPerformanceFilterBtn');
        var $resetBtn = $('#teamPerformanceResetBtn, #teamPane #teamPerformanceResetBtn');
        var originalFilterText = $filterBtn.first().html();
        var originalResetText = $resetBtn.first().html();
        
        $filterBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');
        $resetBtn.prop('disabled', true);

        var loading = layer.load(2, { time: 30 * 1000 });

        // æ›´æ–°å…¨å±€æ—¶é—´çŠ¶æ€ï¼ˆä½¿ç”¨ä¼ å…¥çš„çœŸå®æ—¶é—´å‚æ•°ï¼‰
        if (window.TeamSplit) {
            window.TeamSplit.lastTimebucket = timebucket || 'month';
            window.TeamSplit.lastAtTime = at_time || '';
        }

        $.ajax({
            url: '{:url("Operator/getTeamPerformanceData")}',
            type: 'POST',
            data: {
                timebucket: timebucket || '',
                at_time: at_time || ''
            },
            dataType: 'json',
            timeout: 30000,
            success: function (res) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);

                if (res.code === 0 || res.code === 200) {
                    window.teamPerformanceAllData = res.data || [];
                    window.teamPerformanceTableData = res.data || [];

                    // æ¸²æŸ“è¡¨æ ¼
                    renderTeamPerformanceTable(window.teamPerformanceTableData);

                    // å¦‚æœåœ¨åˆ†æ å¸ƒå±€ä¸­ï¼Œå®ç°è”åŠ¨åˆ·æ–°
                    if ($('#teamPerformanceSplitLayout').is(':visible') && window.TeamSplit) {
                        // æ£€æŸ¥å½“å‰é€‰ä¸­çš„å›¢é˜Ÿæ˜¯å¦åœ¨æ–°æ•°æ®ä¸­å­˜åœ¨
                        var currentTeamExists = false;
                        if (window.TeamSplit.lastTeamId && window.teamPerformanceAllData) {
                            for (var i = 0; i < window.teamPerformanceAllData.length; i++) {
                                if (window.teamPerformanceAllData[i].team_name === window.TeamSplit.lastTeamName) {
                                    currentTeamExists = true;
                                    break;
                                }
                            }
                        }

                        // å¦‚æœå·²é€‰æ‹©å›¢é˜Ÿä¸”å›¢é˜Ÿä»å­˜åœ¨ï¼Œåˆ·æ–°æˆå‘˜æ’å
                        if (window.TeamSplit.lastTeamId && currentTeamExists) {
                            // ä½¿ç”¨æœ¬æ¬¡ç­›é€‰çš„æ—¶é—´å‚æ•°ï¼ˆä¼ å…¥çš„timebucketå’Œat_timeï¼‰
                            var currentTimebucket = timebucket || 'month';
                            var currentAtTime = at_time || '';
                            
                            window.TeamSplit.renderMemberRank(
                                window.TeamSplit.lastTeamId,
                                window.TeamSplit.lastTeamName,
                                currentTimebucket,
                                currentAtTime
                            );
                            
                            // renderMemberRankå†…éƒ¨ä¼šåœ¨successå›è°ƒä¸­è‡ªåŠ¨åˆ·æ–°ä¸ªäººè®¢å•æ¸…å•ï¼ˆå¦‚æœå·²é€‰æ‹©æˆå‘˜ï¼‰
                        } else {
                            // å¦‚æœå›¢é˜Ÿä¸å­˜åœ¨ï¼Œæ¸…ç©ºä¸­é—´å’Œå³ä¾§é¢æ¿
                            if (!currentTeamExists && window.TeamSplit.lastTeamId) {
                                $('#memberPane').html('<div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i><p style="font-size: 16px; margin: 0;">å½“å‰æ—¶é—´èŒƒå›´æ— æ•°æ®</p></div>');
                                $('#memberDetailPane').html('<div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i><p style="font-size: 16px; margin: 0;">è¯·ç‚¹å‡»ä¸šåŠ¡å‘˜åç§°æŸ¥çœ‹ä¸ªäººä¸šç»©æ¸…å•</p></div>');
                                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                                window.TeamSplit.lastTeamId = null;
                                window.TeamSplit.lastTeamName = null;
                                window.TeamSplit.lastMemberName = null;
                                $('#teamPerformanceTableBody tr.team-row, #teamPane #teamPerformanceTableBody tr.team-row').removeClass('is-active');
                                $('.member-name-clickable').removeClass('is-active');
                            }
                        }
                    }

                    if (successCallback) {
                        successCallback();
                    }
                } else {
                    layer.msg(res.msg || 'è·å–å›¢é˜Ÿä¸šç»©æ•°æ®å¤±è´¥', { icon: 2 });
                    if (errorCallback) {
                        errorCallback();
                    }
                }
            },
            error: function (xhr, status) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);
                
                layer.msg(status === 'timeout' ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•' : 'ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', { icon: 2 });
                if (errorCallback) {
                    errorCallback();
                }
            }
        });
    }

    // æ¸²æŸ“å›¢é˜Ÿä¸šç»©è¡¨ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
    function renderTeamPerformanceTable(data) {
        // æ”¯æŒåœ¨å¼¹çª—å’Œåˆ†æ å¸ƒå±€ä¸­æ¸²æŸ“
        var $tbody = $('#teamPerformanceTableBody, #teamPane #teamPerformanceTableBody');
        if (!$tbody.length) return;

        $tbody.empty();

        if (data && data.length) {
            $.each(data, function (idx, item) {
                var teamName = item.team_name || '';
                var row = '<tr class="team-row" data-team="' + (teamName.replace(/"/g, '&quot;')) + '">' +
                    '<td>' + (item.rank || (idx + 1)) + '</td>' +
                    '<td><strong style="color:#4f7cff;">' + teamName + '</strong></td>' +
                    '<td style="text-align:right; color:#28a745;">' + (item.profit || '0.00') + '</td>' +
                    '<td style="text-align:right;">' + (item.profit_rate || '0.00') + '%</td>' +
                    '</tr>';
                $tbody.append(row);
            });
        } else {
            $tbody.append('<tr><td colspan="4" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>');
        }
        
        // å¦‚æœåœ¨åˆ†æ å¸ƒå±€ä¸­ï¼Œé‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
        if ($('#teamPerformanceSplitLayout').is(':visible')) {
            setTimeout(function() {
                initTeamRowClick();
            }, 100);
        }
    }

    // ç»Ÿä¸€è·å–å›¢é˜Ÿä¸šç»©æ—¶é—´å‚æ•°ï¼ˆä¼˜å…ˆè¯»å–å¯è§çš„æ§ä»¶ï¼Œä¼˜å…ˆteamPaneï¼‰
    function getTeamTimeParams() {
        // ä¼˜å…ˆè¯»å–åˆ†æ å·¦ä¾§å¯è§çš„æ§ä»¶
        var $timeFilter = $('#teamPane #teamPerformanceTimeFilter:visible');
        if ($timeFilter.length === 0) {
            // å¦‚æœæ²¡å–åˆ°ï¼Œå†è¯»å–å¼¹çª—å¯è§æ§ä»¶
            $timeFilter = $('#teamPerformanceTimeFilter:visible');
        }
        
        if ($timeFilter.length === 0) {
            // å¦‚æœéƒ½å–ä¸åˆ°ï¼Œè¿”å›é»˜è®¤å€¼
            return {timebucket: 'month', at_time: ''};
        }
        
        var timeFilter = $timeFilter.val() || 'month';
        var timebucket = '';
        var at_time = '';
        
        if (timeFilter === 'custom') {
            // è‡ªå®šä¹‰æ—¶é—´ï¼šä¼˜å…ˆè¯»å–teamPaneå†…çš„start/endï¼ˆ:visibleï¼‰ï¼Œå…¶æ¬¡å¼¹çª—
            var $startDate = $('#teamPane #teamPerformanceStartDate:visible');
            var $endDate = $('#teamPane #teamPerformanceEndDate:visible');
            if ($startDate.length === 0) {
                $startDate = $('#teamPerformanceStartDate:visible');
            }
            if ($endDate.length === 0) {
                $endDate = $('#teamPerformanceEndDate:visible');
            }
            
            var startDate = $startDate.val();
            var endDate = $endDate.val();
            
            if (startDate && endDate) {
                at_time = startDate + ',' + endDate;
                timebucket = '';
            } else {
                layer.msg('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ', {icon: 2});
                return null;
            }
        } else {
            timebucket = timeFilter;
            at_time = '';
        }
        
        return {timebucket: timebucket, at_time: at_time};
    }

    // ç»‘å®šå›¢é˜Ÿä¸šç»©è¡¨çš„ç­›é€‰/é‡ç½®äº‹ä»¶
    function bindTeamPerformanceEvents() {
        // åˆå§‹åŒ–è¡Œç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
        if (typeof initTeamRowClick === 'function') {
            initTeamRowClick();
        }
        
        // æ—¶é—´ç­›é€‰ä¸‹æ‹‰å˜åŒ–ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
        $('#teamPerformanceTimeFilter, #teamPane #teamPerformanceTimeFilter').off('change').on('change', function() {
            var value = $(this).val();
            var $customRange = $('#teamPerformanceCustomTimeRange, #teamPane #teamPerformanceCustomTimeRange');
            if (value === 'custom') {
                $customRange.css('display', 'flex');
            } else {
                $customRange.css('display', 'none');
            }
        });

        // ç­›é€‰æŒ‰é’®ç‚¹å‡»ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
        $('#teamPerformanceFilterBtn, #teamPane #teamPerformanceFilterBtn').off('click').on('click', function() {
            var timeParams = getTeamTimeParams();
            if (!timeParams) {
                return; // è‡ªå®šä¹‰æ—¶é—´æœªé€‰æ‹©å®Œæ•´ï¼ŒgetTeamTimeParamså·²ç»æç¤ºäº†
            }
            loadTeamPerformanceData(timeParams.timebucket, timeParams.at_time);
        });

        // é‡ç½®æŒ‰é’®ç‚¹å‡»ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
        $('#teamPerformanceResetBtn, #teamPane #teamPerformanceResetBtn').off('click').on('click', function() {
            $('#teamPerformanceTimeFilter, #teamPane #teamPerformanceTimeFilter').val('month');
            $('#teamPerformanceStartDate, #teamPane #teamPerformanceStartDate').val('');
            $('#teamPerformanceEndDate, #teamPane #teamPerformanceEndDate').val('');
            $('#teamPerformanceCustomTimeRange, #teamPane #teamPerformanceCustomTimeRange').css('display', 'none');
            
            loadTeamPerformanceData('month', '');
        });

        // åˆ·æ–°æŒ‰é’®ï¼ˆæ”¯æŒå¼¹çª—å’Œåˆ†æ å¸ƒå±€ï¼‰
        $('#teamPerformanceRefresh, #teamPane #teamPerformanceRefresh').off('click').on('click', function() {
            var timeParams = getTeamTimeParams();
            if (!timeParams) {
                // è‡ªå®šä¹‰æ—¶é—´æœªé€‰æ‹©å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤å€¼
                timeParams = {timebucket: 'month', at_time: ''};
            }
            loadTeamPerformanceData(timeParams.timebucket, timeParams.at_time);
        });
    }

    // ==========ã€æ–°å¢ç»“æŸï¼šå›¢é˜Ÿä¸šç»©è¡¨ - ç‚¹å‡»æŒ‰é’®åŠ è½½æ•°æ®å¹¶å¼¹çª—ã€‘==========

    // === split-layout start ===
    // TeamSplit å¯¹è±¡ï¼šç®¡ç†åˆ†æ å¸ƒå±€çš„æˆå‘˜æ’åæ¸²æŸ“
    window.TeamSplit = window.TeamSplit || {
        lastTeamId: null,
        lastTeamName: null,
        lastMemberName: null,
        lastTimebucket: 'month',
        lastAtTime: '',

        /**
         * æ¸²æŸ“æˆå‘˜æ’ååˆ°ä¸­åˆ—å®¹å™¨
         * @param {string} teamId - å›¢é˜ŸIDï¼ˆè¿™é‡Œç”¨team_nameä½œä¸ºIDï¼‰
         * @param {string} teamName - å›¢é˜Ÿåç§°
         * @param {string} timebucket - æ—¶é—´ç­›é€‰ï¼ˆtoday/yesterday/week/month/year/customï¼‰
         * @param {string} at_time - è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ï¼ˆæ ¼å¼ï¼šstart_date,end_dateï¼‰
         */
        renderMemberRank: function(teamId, teamName, timebucket, at_time) {
            var self = this;
            
            // ä¿å­˜å½“å‰é€‰æ‹©çš„å›¢é˜Ÿä¿¡æ¯å’Œæ—¶é—´å‚æ•°
            self.lastTeamId = teamId;
            self.lastTeamName = teamName;
            self.lastTimebucket = timebucket || 'month';
            self.lastAtTime = at_time || '';

            // æ›´æ–°ä¸­åˆ—æ ‡é¢˜
            var timeDisplay = self._formatTimeDisplay(timebucket, at_time);
            $('#memberPaneTitle').html('ğŸ‘¥ å›¢é˜Ÿï¼š' + (teamName || 'æœªçŸ¥å›¢é˜Ÿ') + ' - æˆå‘˜ä¸šç»©æ’å <small style="font-size: 12px; opacity: 0.8;">(' + timeDisplay + ')</small>');

            // è·å–ä¸­åˆ—å®¹å™¨
            var $memberPane = $('#memberPane');
            if (!$memberPane.length) {
                console.error('[TeamSplit] #memberPane å®¹å™¨ä¸å­˜åœ¨');
                layer.msg('æ¸²æŸ“å®¹å™¨ä¸å­˜åœ¨', {icon: 2});
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $memberPane.html('<div class="text-center" style="padding: 60px 20px; color: #6c757d;"><i class="bi bi-hourglass-split" style="font-size: 24px; display: block; margin-bottom: 15px;"></i><p>åŠ è½½ä¸­...</p></div>');

            // è°ƒç”¨æ¥å£è·å–æ•°æ®
            $.ajax({
                url: '{:url("Operator/getTeamMemberPerformanceData")}',
                type: 'POST',
                data: {
                    team_name: teamName,
                    timebucket: timebucket || '',
                    at_time: at_time || ''
                },
                dataType: 'json',
                timeout: 30000,
                success: function(res) {
                    if (res.code === 200 && res.data && res.data.length > 0) {
                        // æ¸²æŸ“è¡¨æ ¼
                        self._renderMemberTable($memberPane, res.data, teamName, timeDisplay);
                        
                        // æ£€æŸ¥å½“å‰é€‰ä¸­çš„æˆå‘˜æ˜¯å¦åœ¨æ–°æ•°æ®ä¸­å­˜åœ¨
                        var currentMemberExists = false;
                        if (self.lastMemberName && res.data) {
                            for (var i = 0; i < res.data.length; i++) {
                                if (res.data[i].username === self.lastMemberName) {
                                    currentMemberExists = true;
                                    break;
                                }
                            }
                        }
                        
                        // å¦‚æœå·²é€‰æ‹©æˆå‘˜ä¸”æˆå‘˜ä»å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ·æ–°ä¸ªäººè®¢å•æ¸…å•
                        if (self.lastMemberName && currentMemberExists) {
                            self.renderMemberDetail(self.lastMemberName, timebucket || self.lastTimebucket, at_time || self.lastAtTime);
                        } else if (self.lastMemberName && !currentMemberExists) {
                            // å¦‚æœæˆå‘˜ä¸å­˜åœ¨ï¼Œæ¸…ç©ºå³ä¾§é¢æ¿
                            $('#memberDetailPane').html('<div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i><p style="font-size: 16px; margin: 0;">å½“å‰æ—¶é—´èŒƒå›´æ— æ•°æ®</p></div>');
                            self.lastMemberName = null;
                            $('.member-name-clickable').removeClass('is-active');
                        }
                    } else {
                        $memberPane.html('<div class="text-center" style="padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 15px;"></i><p>æš‚æ— æ•°æ®</p></div>');
                        // æ¸…ç©ºå³ä¾§é¢æ¿
                        if (self.lastMemberName) {
                            $('#memberDetailPane').html('<div class="empty" style="text-align: center; padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i><p style="font-size: 16px; margin: 0;">è¯·ç‚¹å‡»ä¸šåŠ¡å‘˜åç§°æŸ¥çœ‹ä¸ªäººä¸šç»©æ¸…å•</p></div>');
                            self.lastMemberName = null;
                            $('.member-name-clickable').removeClass('is-active');
                        }
                    }
                },
                error: function(xhr, status) {
                    var errorMsg = status === 'timeout' ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•' : 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    $memberPane.html('<div class="text-center" style="padding: 60px 20px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px; display: block; margin-bottom: 15px;"></i><p>' + errorMsg + '</p></div>');
                }
            });
        },

        /**
         * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
         * @private
         */
        _formatTimeDisplay: function(timebucket, at_time) {
            if (at_time && at_time.indexOf(',') !== -1) {
                var dates = at_time.split(',');
                if (dates.length === 2) {
                    return dates[0].trim() + ' è‡³ ' + dates[1].trim();
                }
                return at_time;
            } else if (timebucket) {
                var timeMap = {
                    'today': 'ä»Šå¤©',
                    'yesterday': 'æ˜¨å¤©',
                    'week': 'æœ¬å‘¨',
                    'month': 'æœ¬æœˆ',
                    'year': 'æœ¬å¹´'
                };
                return timeMap[timebucket] || timebucket;
            }
            return 'æœ¬æœˆ';
        },

        /**
         * æ¸²æŸ“æˆå‘˜æ’åè¡¨æ ¼
         * @private
         */
        _renderMemberTable: function($container, data, teamName, timeDisplay) {
            var html = '<div style="background: #ffffff; border-radius: 8px; overflow: hidden;">' +
                '<div style="padding: 15px 20px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">' +
                '<span style="margin-right: 20px; color: #495057;">å›¢é˜Ÿåç§°ï¼š<strong style="color: #212529;">' + (teamName || 'æœªçŸ¥å›¢é˜Ÿ') + '</strong></span>' +
                '<span style="color: #495057;">æ—¶é—´å£å¾„ï¼š<strong style="color: #212529;">' + timeDisplay + '</strong></span>' +
                '</div>' +
                '<div style="padding: 20px; overflow-x: auto;">' +
                '<table class="wukong-table" style="width: 100%; border-collapse: collapse;">' +
                '<thead style="background: #f8f9fa;">' +
                '<tr>' +
                '<th style="width: 80px; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">æ’å</th>' +
                '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">ä¸šåŠ¡å‘˜åç§°</th>' +
                '<th style="padding: 12px; text-align: right; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">æ€»åˆ©æ¶¦</th>' +
                '<th style="padding: 12px; text-align: right; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">åˆ©æ¶¦ç‡</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';

            if (data && data.length > 0) {
                $.each(data, function(index, item) {
                    var username = item.username || '';
                    html += '<tr style="border-bottom: 1px solid #dee2e6;">' +
                        '<td style="padding: 12px;">' + (item.rank || (index + 1)) + '</td>' +
                        '<td style="padding: 12px;"><a href="javascript:void(0);" class="member-name-clickable" data-username="' + encodeURIComponent(username) + '" style="color: #4f7cff; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.2s;">' + username + '</a></td>' +
                        '<td style="padding: 12px; text-align: right; color: #28a745;">' + (item.profit || '0.00') + '</td>' +
                        '<td style="padding: 12px; text-align: right;">' + (item.profit_rate || '0.00') + '%</td>' +
                        '</tr>';
                });
            } else {
                html += '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #6c757d;">æš‚æ— æ•°æ®</td></tr>';
            }

            html += '</tbody></table></div></div>';

            $container.html(html);
            
            // ç»‘å®šä¸šåŠ¡å‘˜åç§°ç‚¹å‡»äº‹ä»¶
            this._bindMemberNameClick();
        },
        
        /**
         * ç»‘å®šä¸šåŠ¡å‘˜åç§°ç‚¹å‡»äº‹ä»¶
         * @private
         */
        _bindMemberNameClick: function() {
            var self = this;
            // å…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬ï¼Œé¿å…é‡å¤ç»‘å®š
            $(document).off('click', '.member-name-clickable');
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶
            $(document).on('click', '.member-name-clickable', function(e) {
                e.preventDefault();
                
                // ç§»é™¤å…¶ä»–ä¸šåŠ¡å‘˜åç§°çš„ active æ ·å¼
                $('.member-name-clickable').removeClass('is-active');
                
                // ç»™å½“å‰ä¸šåŠ¡å‘˜åç§°æ·»åŠ  active æ ·å¼
                $(this).addClass('is-active');
                
                // è·å–ä¸šåŠ¡å‘˜åç§°ï¼šä¼˜å…ˆè¯»å–åŸå§‹å±æ€§å¹¶è¿›è¡Œè§£ç 
                var raw = $(this).attr('data-username') || $(this).text().trim();
                var username = raw;
                try { 
                    username = decodeURIComponent(raw); 
                } catch(e) { 
                    username = raw; 
                }
                username = (username || '').trim();
                
                console.log('[member click] ä¸šåŠ¡å‘˜åç§°:', username);
                
                if (!username) {
                    console.error('[member click] æ— æ³•è·å–ä¸šåŠ¡å‘˜åç§°');
                    return;
                }
                
                // ä½¿ç”¨å½“å‰ç­›é€‰çš„æ—¶é—´å‚æ•°ï¼ˆä¼˜å…ˆä»ç­›é€‰å™¨è·å–ï¼Œå¦åˆ™ä½¿ç”¨ä¿å­˜çš„æ—¶é—´å‚æ•°ï¼‰
                var timeParams = getTeamTimeParams();
                var timebucket = '';
                var at_time = '';
                
                if (timeParams) {
                    timebucket = timeParams.timebucket;
                    at_time = timeParams.at_time;
                } else {
                    // å¦‚æœgetTeamTimeParamsè¿”å›nullï¼ˆè‡ªå®šä¹‰æ—¶é—´æœªé€‰æ‹©å®Œæ•´ï¼‰ï¼Œä½¿ç”¨ä¿å­˜çš„æ—¶é—´å‚æ•°
                    timebucket = self.lastTimebucket || 'month';
                    at_time = self.lastAtTime || '';
                }
                
                // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“åˆ°å³åˆ—ï¼ˆä¼ å…¥è§£ç åçš„ä¸­æ–‡ç”¨æˆ·åï¼‰
                self.renderMemberDetail(username, timebucket, at_time);
            });
        },
        
        /**
         * æ¸²æŸ“ä¸ªäººä¸šç»©æ¸…å•åˆ°å³åˆ—å®¹å™¨
         * @param {string} username - ä¸šåŠ¡å‘˜åç§°
         * @param {string} timebucket - æ—¶é—´ç­›é€‰ï¼ˆtoday/yesterday/week/month/year/customï¼‰
         * @param {string} at_time - è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ï¼ˆæ ¼å¼ï¼šstart_date,end_dateï¼‰
         */
        renderMemberDetail: function(username, timebucket, at_time) {
            var self = this;
            
            // ä¿å­˜å½“å‰é€‰æ‹©çš„æˆå‘˜ä¿¡æ¯å’Œæ—¶é—´å‚æ•°
            self.lastMemberName = username;
            self.lastTimebucket = timebucket || self.lastTimebucket || 'month';
            self.lastAtTime = at_time || self.lastAtTime || '';
            
            // æ›´æ–°å³åˆ—æ ‡é¢˜
            var timeDisplay = self._formatTimeDisplay(timebucket || self.lastTimebucket, at_time || self.lastAtTime);
            $('#memberDetailPaneTitle').html('ğŸ“‹ ' + username + ' - ä¸ªäººä¸šç»©æ¸…å• <small style="font-size: 12px; opacity: 0.8;">(' + timeDisplay + ')</small>');
            
            // è·å–å³åˆ—å®¹å™¨
            var $memberDetailPane = $('#memberDetailPane');
            if (!$memberDetailPane.length) {
                console.error('[TeamSplit] #memberDetailPane å®¹å™¨ä¸å­˜åœ¨');
                layer.msg('æ¸²æŸ“å®¹å™¨ä¸å­˜åœ¨', {icon: 2});
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $memberDetailPane.html('<div class="text-center" style="padding: 60px 20px; color: #6c757d;"><i class="bi bi-hourglass-split" style="font-size: 24px; display: block; margin-bottom: 15px;"></i><p>åŠ è½½ä¸­...</p></div>');
            
            // è°ƒç”¨æ¥å£è·å–æ•°æ®
            $.ajax({
                url: '{:url("Operator/getMemberPerformanceDetail")}',
                type: 'POST',
                data: {
                    username: username,
                    timebucket: timebucket || '',
                    at_time: at_time || ''
                },
                dataType: 'json',
                timeout: 30000,
                success: function(res) {
                    if (res.code === 200 && res.data && res.data.length > 0) {
                        // æ¸²æŸ“è¡¨æ ¼
                        self._renderMemberDetailTable($memberDetailPane, res.data, username, timeDisplay);
                    } else {
                        $memberDetailPane.html('<div class="text-center" style="padding: 60px 20px; color: #6c757d;"><i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 15px;"></i><p>æš‚æ— æ•°æ®</p></div>');
                    }
                },
                error: function(xhr, status) {
                    var errorMsg = status === 'timeout' ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•' : 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    $memberDetailPane.html('<div class="text-center" style="padding: 60px 20px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px; display: block; margin-bottom: 15px;"></i><p>' + errorMsg + '</p></div>');
                }
            });
        },
        
        /**
         * æ¸²æŸ“ä¸ªäººä¸šç»©æ¸…å•è¡¨æ ¼
         * @private
         */
        _renderMemberDetailTable: function($container, data, username, timeDisplay) {
            var html = '<div style="background: #ffffff; border-radius: 8px; overflow: hidden;">' +
                '<div style="padding: 15px 20px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">' +
                '<span style="margin-right: 20px; color: #495057;">ä¸šåŠ¡å‘˜ï¼š<strong style="color: #212529;">' + username + '</strong></span>' +
                '<span style="color: #495057;">æ—¶é—´å£å¾„ï¼š<strong style="color: #212529;">' + timeDisplay + '</strong></span>' +
                '</div>' +
                '<div style="padding: 20px; overflow-x: auto;">' +
                '<table class="wukong-table" style="width: 100%; border-collapse: collapse;">' +
                '<thead style="background: #f8f9fa;">' +
                '<tr>' +
                '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">æˆäº¤æ—¥æœŸ</th>' +
                '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">å®¢æˆ·åç§°</th>' +
                '<th style="padding: 12px; text-align: right; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">è®¢å•é‡‘é¢</th>' +
                '<th style="padding: 12px; text-align: right; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">åˆ©æ¶¦</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
            
            if (data && data.length > 0) {
                $.each(data, function(index, item) {
                    html += '<tr style="border-bottom: 1px solid #dee2e6;">' +
                        '<td style="padding: 12px;">' + (item.order_time || item.deal_date || '') + '</td>' +
                        '<td style="padding: 12px;">' + (item.client_name || item.customer_name || '') + '</td>' +
                        '<td style="padding: 12px; text-align: right;">' + (item.money || item.order_amount || '0.00') + '</td>' +
                        '<td style="padding: 12px; text-align: right; color: #28a745;">' + (item.profit || '0.00') + '</td>' +
                        '</tr>';
                });
            } else {
                html += '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #6c757d;">æš‚æ— æ•°æ®</td></tr>';
            }
            
            html += '</tbody></table></div></div>';
            
            $container.html(html);
        }
    };
    // === split-layout end ===

    
    // æ¸²æŸ“ä¸šç»©è¡¨æ ¼
    function renderPerformanceTable(data) {
        var tbody = $('#performanceTableBody');
        tbody.empty();
        
        if (data && data.length > 0) {
            $.each(data, function(index, item) {
                var row = '<tr>' +
                    '<td>' + (item.rank || (index + 1)) + '</td>' +
                    '<td>' + (item.username || '') + '</td>' +
                    '<td>' + (item.team_name || '') + '</td>' +
                    '<td>' + (item.profit || '0.00') + '</td>' +
                    '<td>' + (item.profit_rate || '0.00') + '%</td>' +
                    '</tr>';
                tbody.append(row);
            });
        } else {
            tbody.append('<tr><td colspan="5" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>');
        }
    }
    
    // ç»‘å®šè¡¨å¤´æ’åºåŠŸèƒ½
    function bindTableSort() {
        var currentSort = {
            field: 'profit',
            order: 'desc' // desc: é™åº, asc: å‡åº
        };
        
        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons(field, order) {
            $('#performanceTable thead th').each(function() {
                var $th = $(this);
                var $icon = $th.find('.sort-icon');
                var sortField = $th.data('sort');
                
                if (sortField === field) {
                    if (order === 'desc') {
                        $icon.removeClass('bi-arrow-down bi-arrow-up bi-arrow-down-up')
                            .addClass('bi-arrow-down');
                    } else {
                        $icon.removeClass('bi-arrow-down bi-arrow-up bi-arrow-down-up')
                            .addClass('bi-arrow-up');
                    }
                } else {
                    $icon.removeClass('bi-arrow-down bi-arrow-up')
                        .addClass('bi-arrow-down-up');
                }
            });
        }
        
        // æ’åºå‡½æ•°
        function sortTable(field, order) {
            if (!window.performanceTableData || window.performanceTableData.length === 0) {
                return;
            }
            
            var data = window.performanceTableData.slice(); // å¤åˆ¶æ•°ç»„
            
            data.sort(function(a, b) {
                var aVal, bVal;
                
                // æ ¹æ®å­—æ®µè·å–å€¼
                switch(field) {
                    case 'rank':
                        aVal = parseInt(a.rank || 0);
                        bVal = parseInt(b.rank || 0);
                        break;
                    case 'username':
                        aVal = (a.username || '').toLowerCase();
                        bVal = (b.username || '').toLowerCase();
                        break;
                    case 'team_name':
                        aVal = (a.team_name || '').toLowerCase();
                        bVal = (b.team_name || '').toLowerCase();
                        break;
                    case 'profit':
                        aVal = parseFloat(a.profit || 0);
                        bVal = parseFloat(b.profit || 0);
                        break;
                    case 'profit_rate':
                        aVal = parseFloat(a.profit_rate || 0);
                        bVal = parseFloat(b.profit_rate || 0);
                        break;
                    default:
                        return 0;
                }
                
                // æ¯”è¾ƒå€¼
                if (typeof aVal === 'string') {
                    if (order === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                } else {
                    if (order === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                }
            });
            
            // é‡æ–°è®¡ç®—æ’å
            if (field === 'rank') {
                // å¦‚æœæŒ‰æ’åæ’åºï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—
            } else {
                // å…¶ä»–æ’åºéœ€è¦é‡æ–°è®¡ç®—æ’å
                $.each(data, function(index, item) {
                    item.rank = index + 1;
                });
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderPerformanceTable(data);
            updateSortIcons(field, order);
        }
        
        // ç»‘å®šè¡¨å¤´ç‚¹å‡»äº‹ä»¶
        $('#performanceTable thead th[data-sort]').off('click').on('click', function() {
            var $th = $(this);
            var field = $th.data('sort');
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºå­—æ®µï¼Œåˆ‡æ¢æ’åºæ–¹å‘
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'desc'; // é»˜è®¤é™åº
            }
            
            sortTable(currentSort.field, currentSort.order);
        });
        
        // åˆå§‹åŒ–æ’åºå›¾æ ‡
        updateSortIcons(currentSort.field, currentSort.order);
    }
    
    // å¡«å……ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
    function fillPerformanceUserFilter(data) {
        var $select = $('#performanceUserFilter');
        $select.empty();
        $select.append('<option value="">å…¨éƒ¨ä¸šåŠ¡å‘˜</option>');
        
        if (data && data.length > 0) {
            // è·å–æ‰€æœ‰å”¯ä¸€çš„ä¸šåŠ¡å‘˜
            var users = [];
            var userMap = {};
            $.each(data, function(index, item) {
                if (item.username && !userMap[item.username]) {
                    userMap[item.username] = true;
                    users.push({
                        username: item.username,
                        team_name: item.team_name || ''
                    });
                }
            });
            
            // æŒ‰å›¢é˜Ÿå’Œå§“åæ’åº
            users.sort(function(a, b) {
                if (a.team_name !== b.team_name) {
                    return (a.team_name || '').localeCompare(b.team_name || '');
                }
                return (a.username || '').localeCompare(b.username || '');
            });
            
            // å¡«å……ä¸‹æ‹‰æ¡†
            $.each(users, function(index, user) {
                var displayName = user.username;
                if (user.team_name) {
                    displayName += ' (' + user.team_name + ')';
                }
                $select.append('<option value="' + user.username + '">' + displayName + '</option>');
            });
        }
    }
    
    // ç»‘å®šç­›é€‰åŠŸèƒ½
    function bindPerformanceFilter() {
        // æ—¶é—´ç­›é€‰ä¸‹æ‹‰æ¡†å˜åŒ–
        $('#performanceTimeFilter').off('change').on('change', function() {
            var value = $(this).val();
            if (value === 'custom') {
                $('#performanceCustomTimeRange').css('display', 'flex');
            } else {
                $('#performanceCustomTimeRange').css('display', 'none');
            }
        });
        
        // ç­›é€‰æŒ‰é’®ç‚¹å‡»
        $('#performanceFilterBtn').off('click').on('click', function() {
            filterPerformanceTable();
        });
        
        // é‡ç½®æŒ‰é’®ç‚¹å‡»
        $('#performanceResetBtn').off('click').on('click', function() {
            resetPerformanceFilter();
        });
        
        // å›è½¦é”®è§¦å‘ç­›é€‰
        $('#performanceUserFilter, #performanceTimeFilter, #performanceStartDate, #performanceEndDate').off('keypress').on('keypress', function(e) {
            if (e.which === 13) {
                filterPerformanceTable();
            }
        });
    }
    
    // ç­›é€‰è¡¨æ ¼
    function filterPerformanceTable() {
        var selectedUser = $('#performanceUserFilter').val();
        var timeFilter = $('#performanceTimeFilter').val();
        var startDate = $('#performanceStartDate').val();
        var endDate = $('#performanceEndDate').val();
        
        // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰æ—¶é—´æˆ–æ—¶é—´ç­›é€‰æ”¹å˜ï¼Œéœ€è¦é‡æ–°è¯·æ±‚æ•°æ®
        if (timeFilter === 'custom' && startDate && endDate) {
            // ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´èŒƒå›´é‡æ–°è¯·æ±‚æ•°æ®
            loadPerformanceData(selectedUser, '', startDate + ',' + endDate);
        } else if (timeFilter && timeFilter !== 'custom') {
            // ä½¿ç”¨é¢„è®¾æ—¶é—´èŒƒå›´é‡æ–°è¯·æ±‚æ•°æ®
            loadPerformanceData(selectedUser, timeFilter, '');
        } else {
            // åªåšå‰ç«¯ç­›é€‰ï¼ˆä¸šåŠ¡å‘˜ç­›é€‰ï¼‰- æ˜¾ç¤ºåŠ è½½æç¤º
            var loading = layer.load(2, {
                time: 5000,
                content: '<div style="padding: 20px; text-align: center;"><i class="bi bi-hourglass-split" style="font-size: 24px;"></i><br><br>æ­£åœ¨ç­›é€‰æ•°æ®...</div>'
            });
            
            // ä½¿ç”¨ setTimeout è®© UI æœ‰æ—¶é—´æ˜¾ç¤ºåŠ è½½æç¤º
            setTimeout(function() {
                var filteredData = window.performanceAllData || [];
                
                if (selectedUser) {
                    filteredData = filteredData.filter(function(item) {
                        return item.username === selectedUser;
                    });
                }
                
                window.performanceTableData = filteredData;
                renderPerformanceTable(filteredData);
                
                // é‡æ–°è®¡ç®—æ’å
                $.each(window.performanceTableData, function(index, item) {
                    item.rank = index + 1;
                });
                
                // æ›´æ–°æ’åºå›¾æ ‡
                if (window.performanceTableData.length > 0) {
                    bindTableSort();
                }
                
                layer.close(loading);
            }, 50); // 50ms å»¶è¿Ÿï¼Œç¡®ä¿åŠ è½½æç¤ºæ˜¾ç¤º
        }
    }
    
    // é‡ç½®ç­›é€‰
    function resetPerformanceFilter() {
        $('#performanceUserFilter').val('');
        $('#performanceTimeFilter').val('month');
        $('#performanceCustomTimeRange').css('display', 'none');
        $('#performanceStartDate').val('');
        $('#performanceEndDate').val('');
        
        // é‡æ–°åŠ è½½æ•°æ®ï¼ˆä½¿ç”¨é»˜è®¤æ—¶é—´ï¼‰
        loadPerformanceData('', 'month', '');
    }
    
    // åŠ è½½ä¸šç»©æ•°æ®
    function loadPerformanceData(username, timebucket, at_time) {
        // ç¦ç”¨ç­›é€‰æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        var $filterBtn = $('#performanceFilterBtn');
        var $resetBtn = $('#performanceResetBtn');
        var originalFilterText = $filterBtn.html();
        var originalResetText = $resetBtn.html();
        
        $filterBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...');
        $resetBtn.prop('disabled', true);
        
        var loading = layer.load(2, {
            time: 30*1000,
          
        });
        
        $.ajax({
            url: '{:url("Operator/getPerformanceData")}',
            type: 'POST',
            data: {
                username: username,
                timebucket: timebucket,
                at_time: at_time
            },
            dataType: 'json',
            timeout: 30000,
            success: function(res) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);
                
                if (res.code === 0 || res.code === 200) {
                    window.performanceTableData = res.data || [];
                    window.performanceAllData = res.data || [];
                    
                    // æ›´æ–°ä¸šåŠ¡å‘˜ä¸‹æ‹‰æ¡†
                    fillPerformanceUserFilter(window.performanceAllData);
                    
                    // å¦‚æœç­›é€‰äº†ä¸šåŠ¡å‘˜ï¼Œè®¾ç½®ä¸‹æ‹‰æ¡†å€¼
                    if (username) {
                        $('#performanceUserFilter').val(username);
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderPerformanceTable(window.performanceTableData);
                    
                    // é‡æ–°ç»‘å®šæ’åº
                    bindTableSort();
                } else {
                    layer.msg(res.msg || 'è·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loading);
                $filterBtn.prop('disabled', false).html(originalFilterText);
                $resetBtn.prop('disabled', false).html(originalResetText);
                
                if (status === 'timeout') {
                    layer.msg('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                } else {
                    layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè·å–æ•°æ®å¤±è´¥', {icon: 2});
                }
            }
        });
    }
</script>