<!-- å›¢é˜Ÿä¸šç»©è¡¨å¼¹çª— -->
<style>
    /* å›¢é˜Ÿä¸šç»©è¡¨è¡Œç‚¹å‡»æ ·å¼ */
    #teamPerformanceTableBody tr.team-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    #teamPerformanceTableBody tr.team-row:hover {
        background-color: #f5faff;
    }
    #teamPerformanceTableBody tr.team-row.is-active {
        background-color: #e8f1ff !important;
    }
</style>
<div id="teamPerformanceModal" style="display:none; padding:20px; background:#f6f8fb;">

    <div class="wukong-table-card" style="background:#ffffff; width: 100%; max-width: none;">
        <!-- å¤´éƒ¨ -->
        <div class="wukong-table-card-header"
             style="display:flex;align-items:center;justify-content:space-between;
                    background:linear-gradient(90deg,#4f7cff,#6fa1ff);
                    color:#fff;">
            <span style="font-size:16px;font-weight:600;">
                ğŸ§© å›¢é˜Ÿä¸šç»©æ’è¡Œæ¦œ
            </span>
            <div>
                <button class="btn btn-sm btn-light" id="teamPerformanceRefresh">
                    <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- æ—¶é—´ç­›é€‰æ  -->
        <div class="filter-bar" style="padding: 15px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; white-space: nowrap;">æ—¶é—´ç­›é€‰ï¼š</label>
                <select id="teamPerformanceTimeFilter" class="form-select" style="width: 150px;">
                    <option value="today">ä»Šå¤©</option>
                    <option value="yesterday">æ˜¨å¤©</option>
                    <option value="week">æœ¬å‘¨</option>
                    <option value="month" selected>æœ¬æœˆ</option>
                    <option value="year">æœ¬å¹´</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div id="teamPerformanceCustomTimeRange" style="display: none; gap: 8px; align-items: center;">
                <input type="date" id="teamPerformanceStartDate" class="form-control" style="width: 150px;">
                <span>è‡³</span>
                <input type="date" id="teamPerformanceEndDate" class="form-control" style="width: 150px;">
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="teamPerformanceFilterBtn" style="margin-left: auto;">
                <i class="bi bi-search"></i> ç­›é€‰
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="teamPerformanceResetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
            </button>
        </div>

        <!-- è¡¨æ ¼åŒº -->
        <div class="wukong-table-card-body" style="overflow-x: auto;">
            <div>
                <table class="wukong-table" id="teamPerformanceTable" style="width:100%;">
                    <thead>
                        <tr>
                            <th style="width:70px;">æ’å</th>
                            <th>å›¢é˜Ÿåç§°</th>
                            <th style="text-align:right;">æ€»åˆ©æ¶¦</th>
                            <th style="text-align:right;">åˆ©æ¶¦ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="teamPerformanceTableBody">
                        <tr><td colspan="4" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                    </tbody>                    
                </table>
            </div>
        </div>
    </div>

</div>

<script>
// === split-layout start ===
/**
 * åˆå§‹åŒ–å›¢é˜Ÿä¸šç»©è¡¨è¡Œç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
 * æ”¹ä¸ºåœ¨åˆ†æ å¸ƒå±€ä¸­ä½¿ç”¨ï¼Œç‚¹å‡»å›¢é˜Ÿè¡Œæ—¶æ¸²æŸ“æˆå‘˜æ’ååˆ°ä¸­åˆ—
 */
function initTeamRowClick() {
    // å…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬ï¼Œé¿å…é‡å¤ç»‘å®š
    $(document).off('click', '#teamPerformanceTable tbody tr.team-row, #teamPane #teamPerformanceTable tbody tr.team-row');
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒåœ¨å¼¹çª—å’Œåˆ†æ å¸ƒå±€ä¸­ä½¿ç”¨ï¼‰
    $(document).on('click', '#teamPerformanceTable tbody tr.team-row, #teamPane #teamPerformanceTable tbody tr.team-row', function() {
        console.log('[team click] ç‚¹å‡»äº‹ä»¶è§¦å‘');
        
        // ç§»é™¤å…¶ä»–è¡Œçš„ active æ ·å¼
        $('#teamPerformanceTableBody tr.team-row, #teamPane #teamPerformanceTableBody tr.team-row').removeClass('is-active');
        
        // ç»™å½“å‰è¡Œæ·»åŠ  active æ ·å¼
        $(this).addClass('is-active');
        
        // è·å–å›¢é˜Ÿåç§°
        var teamName = $(this).data('team') || $(this).find('td').eq(1).text().trim();
        console.log('[team click] å›¢é˜Ÿåç§°:', teamName);
        
        if (!teamName) {
            console.error('[team click] æ— æ³•è·å–å›¢é˜Ÿåç§°');
            layer.msg('æ— æ³•è·å–å›¢é˜Ÿåç§°', {icon: 2});
            return;
        }
        
        // è¯»å–å½“å‰çš„æ—¶é—´ç­›é€‰å€¼ï¼ˆä¼˜å…ˆè¯»å–teamPaneå¯è§æ§ä»¶ï¼Œå…¶æ¬¡å¼¹çª—å¯è§æ§ä»¶ï¼‰
        var $timeFilter = $('#teamPane #teamPerformanceTimeFilter:visible');
        if ($timeFilter.length === 0) {
            $timeFilter = $('#teamPerformanceTimeFilter:visible');
        }
        var timeFilter = $timeFilter.val() || 'month';
        var timebucket = '';
        var at_time = '';
        
        // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´ï¼Œè¯»å–èµ·æ­¢æ—¥æœŸï¼ˆä¼˜å…ˆè¯»å–teamPaneå¯è§æ§ä»¶ï¼Œå…¶æ¬¡å¼¹çª—ï¼‰
        if (timeFilter === 'custom') {
            var $startDate = $('#teamPane #teamPerformanceStartDate:visible');
            var $endDate = $('#teamPane #teamPerformanceEndDate:visible');
            if ($startDate.length === 0) {
                $startDate = $('#teamPerformanceStartDate:visible');
            }
            if ($endDate.length === 0) {
                $endDate = $('#teamPerformanceEndDate:visible');
            }
            
            var startDate = $startDate.val();
            var endDate = $endDate.val();
            if (startDate && endDate) {
                at_time = startDate + ',' + endDate;
                timebucket = ''; // è‡ªå®šä¹‰æ—¶é—´æ—¶ï¼Œtimebucket ç½®ç©º
            } else {
                layer.msg('è¯·å…ˆé€‰æ‹©è‡ªå®šä¹‰æ—¶é—´èŒƒå›´', {icon: 2});
                return;
            }
        } else {
            timebucket = timeFilter;
            at_time = '';
        }
        
        console.log('[team click] æ—¶é—´å‚æ•°:', {timebucket: timebucket, at_time: at_time});
        
        // æ£€æŸ¥æ˜¯å¦åœ¨åˆ†æ å¸ƒå±€ä¸­ï¼ˆé€šè¿‡æ£€æŸ¥ #teamPerformanceSplitLayout æ˜¯å¦æ˜¾ç¤ºï¼‰
        if ($('#teamPerformanceSplitLayout').is(':visible')) {
            // åœ¨åˆ†æ å¸ƒå±€ä¸­ï¼šè°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“åˆ°ä¸­åˆ—
            if (window.TeamSplit && typeof window.TeamSplit.renderMemberRank === 'function') {
                window.TeamSplit.renderMemberRank(teamName, teamName, timebucket, at_time);
            } else {
                console.error('[team click] TeamSplit.renderMemberRank å‡½æ•°ä¸å­˜åœ¨');
                layer.msg('æ¸²æŸ“å‡½æ•°æœªåˆå§‹åŒ–', {icon: 2});
            }
        } else {
            // ä¸åœ¨åˆ†æ å¸ƒå±€ä¸­ï¼ˆå¯èƒ½æ˜¯æ—§ä»£ç æˆ–å¼¹çª—æ¨¡å¼ï¼‰ï¼šä¿æŒåŸæœ‰é€»è¾‘ï¼Œæ‰“å¼€å¼¹çª—
            var url = '{:url("Operator/teamMemberPerformancePage")}?team_name=' + encodeURIComponent(teamName);
            if (timebucket) {
                url += '&timebucket=' + encodeURIComponent(timebucket);
            }
            if (at_time) {
                url += '&at_time=' + encodeURIComponent(at_time);
            }
            
            console.log('[team click] æ‰“å¼€å¼¹çª—ï¼ŒURL:', url);
            
            // ä½¿ç”¨ layer.open æ‰“å¼€æ–°çª—å£ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
            layer.open({
                type: 2,
                title: teamName + ' - å›¢é˜Ÿæˆå‘˜ä¸šç»©è¡¨',
                area: ['92%', '85%'],
                closeBtn: 1,
                content: url,
                end: function() {
                    // çª—å£å…³é—­åï¼Œç§»é™¤é€‰ä¸­çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
                    // $('#teamPerformanceTableBody tr.team-row').removeClass('is-active');
                }
            });
        }
    });
    
    console.log('[team click] äº‹ä»¶å§”æ‰˜ç»‘å®šå®Œæˆ');
}
// === split-layout end ===

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–äº‹ä»¶ç»‘å®š
$(document).ready(function() {
    initTeamRowClick();
});
</script>
