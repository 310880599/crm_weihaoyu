<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">
    <script src="/js/jquery.min.js"></script>
    <script src="/static/admin/js/select.js"></script>
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
    <script src="/static/admin/js/china-provinces-cities.js"></script>
    <style>
        .layui-form-pane .layui-form-label {
            width: 110px;
            padding: 8px 15px;
            height: 38px;
            line-height: 20px;
            border-width: 0;
            border-style: none;
            border-radius: 2px 0 0 2px;
            text-align: left;
            background-color: #FBFBFB;
            box-sizing: border-box;
        }

        /* Ensure category name in dropdown is bold */
        .cat-bold {
            font-weight: bold;
        }
        
        /* 确保左侧填写说明完整显示 */
        .admin-main {
            overflow: visible !important;
            min-height: auto !important;
            max-height: none !important;
        }
        
        body {
            overflow: visible !important;
        }
        
        /* 如果页面在iframe中，确保内容可以完整显示 */
        html, body {
            height: auto !important;
            min-height: 100% !important;
        }
        .layui-form-pane .layui-form-label {
    width: 146px;
    padding: 8px 15px;
    height: 38px;
    line-height: 20px;
    border-width: 0;
    border-style: none;
    border-radius: 2px 0 0 2px;
    text-align: left;
    background-color: #FBFBFB;
    box-sizing: border-box;
}
    </style>
</head>

<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">

    <script type="text/javascript">
        // 全局变量：存储客户验证状态
        var customerValidated = false;
        
        // **加粗产品下拉中括号内的分类名称部分** - 移到全局作用域
        function boldCategory($select) {
            // 找到 LayUI 渲染后下拉的所有选项元素，并将括号内的文字加粗
            var $options = $select.next('.layui-form-select').find('dl dd');
            $options.each(function () {
                var text = $(this).text();
                var match = text.match(/^(.*)\s*\((.+)\)\s*$/);
                if (match) {
                    // 用<span class="cat-bold">包裹分类名称部分
                    $(this).html(match[1] + ' (<span class="cat-bold">' + match[2] + '</span>)');
                }
            });
        }
        
        // AJAX function to fetch client info by contact (no changes needed here)
        function changeyewu() {
            var contact = $("#contact").val();
            var contactTrimmed = contact ? contact.trim() : '';
            
            // 如果联系方式为空，清空所有字段并重置验证状态
            if (!contactTrimmed) {
                $('#cname').val('');
                $('#pr_user').empty().append('<option value="">请选择客户负责人</option>');
                $('#oper_user_input').val('');
                $('#country').val('');
                $('#kh_username').val('');
                $('#source').val('');
                $('#source_port').val('');
                $('#team_name').val('');
                $('#client_company').val('');
                customerValidated = false;
                $('#checklabel').html('').css('color', '');
                layui.form.render('select');
                return;
            }
            
            $('#cname').val('');
            customerValidated = false; // 重置验证状态
            
            // 清空之前填充的字段
            $('#pr_user').empty().append('<option value="">请选择客户负责人</option>');
            $('#oper_user_input').val('');
            $('#country').val('');
            $('#kh_username').val('');
            $('#source').val('');
            $('#source_port').val('');
            $('#team_name').val('');
            $('#client_company').val('');
            
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "{:url('Order/changeyewu')}" + "?contact=" + encodeURIComponent(contactTrimmed),
                success: function (result) {
                    if (result['msg']['code'] == 0) {
                        $('#checklabel').css('color', 'red');
                        customerValidated = false; // 客户验证失败
                        
                        // 验证失败时，清空所有已填充的字段
                        $('#cname').val('');
                        $('#pr_user').empty().append('<option value="">请选择客户负责人</option>');
                        $('#oper_user_input').val('');
                        $('#country').val('');
                        $('#kh_username').val('');
                        $('#source').val('');
                        $('#source_port').val('');
                        $('#team_name').val('');
                        $('#client_company').val('');
                        
                        // 清空协同人选择
                        if (window.collaboratorSelectInstance) {
                            window.collaboratorSelectInstance.setValue([]);
                        }
                        
                        // 清空产品明细表格
                        var $tbody = $('#productTableBody');
                        $tbody.empty();
                        var emptyRow = document.createElement('tr');
                        emptyRow.innerHTML =
                            '<td><select name="product_name[]" lay-search lay-verify="required">' + (window.productOptions || $('select[name="product_name[]"]').first().html()) + '</select></td>' +
                            '<td><select name="product_manager[]" lay-search lay-verify="required">' + (window.managerOptions || $('select[name="product_manager[]"]').first().html()) + '</select></td>' +
                            '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                            '<td><select name="unit[]" lay-search lay-verify="required">' + (window.unitOptions || $('select[name="unit[]"]').first().html()) + '</select></td>' +
                            '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                            '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                            '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                            '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                            '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
                        $tbody.append(emptyRow);
                        layui.form.render('select');
                        
                        // 重置金额字段
                        $('#money').val('0.00');
                        $('#profit').val('0.00');
                        $('#margin_rate').val('0.00');
                        
                        // 显示错误提示
                        layer.msg(result['msg']['msg'] || '该客户不属于您的客户或协同人客户，无法添加订单', { icon: 2, time: 3000 });
                    } else {
                        $('#checklabel').css('color', 'green');
                        customerValidated = true; // 客户验证成功
                        // Fill in returned client info
                        $('#cname').val(result['msg']['custname']);
                        
                        // 填充客户负责人下拉选项（包括客户负责人和协同人）
                        var $prUserSelect = $('#pr_user');
                        $prUserSelect.empty();
                        $prUserSelect.append('<option value="">请选择客户负责人</option>');
                        
                        // 获取客户负责人名称
                        var prUserName = result['msg']['pr_user'] || '';
                        
                        // 保存初始的客户负责人和协同人数据（用于联动）
                        window.originalPrUserName = prUserName;
                        window.originalJointPersonNames = [];
                        var jointPersonNames = result['msg']['joint_person_names'] || [];
                        if (jointPersonNames && jointPersonNames.length > 0) {
                            jointPersonNames.forEach(function(person) {
                                var personName = person.name || person.username || person;
                                var personId = person.id || person;
                                // 保存协同人数据（名称和ID的映射）
                                window.originalJointPersonNames.push({
                                    name: personName,
                                    id: personId
                                });
                            });
                        }
                        
                        // 构建所有人员列表（客户负责人 + 协同人）
                        var allPersons = [];
                        if (prUserName) {
                            // 需要从collaboratorData中找到客户负责人的ID
                            var prUserId = null;
                            if (window.collaboratorData && window.collaboratorData.length > 0) {
                                for (var i = 0; i < window.collaboratorData.length; i++) {
                                    if (window.collaboratorData[i].name === prUserName) {
                                        prUserId = window.collaboratorData[i].value;
                                        break;
                                    }
                                }
                            }
                            allPersons.push({
                                name: prUserName,
                                id: prUserId
                            });
                        }
                        // 添加协同人
                        if (jointPersonNames && jointPersonNames.length > 0) {
                            jointPersonNames.forEach(function(person) {
                                var personName = person.name || person.username || person;
                                var personId = person.id || person;
                                // 避免重复添加（如果协同人名字和客户负责人相同）
                                if (personName && personName !== prUserName) {
                                    allPersons.push({
                                        name: personName,
                                        id: personId
                                    });
                                }
                            });
                        }
                        
                        // 保存所有人员列表到全局变量
                        window.allPersonsList = allPersons;
                        
                        // 添加所有人员到客户负责人下拉选项
                        allPersons.forEach(function(person) {
                            $prUserSelect.append('<option value="' + person.name + '">' + person.name + '</option>');
                        });
                        
                        // 默认选中客户负责人
                        if (prUserName) {
                            $prUserSelect.val(prUserName);
                        } else if (allPersons.length > 0) {
                            // 如果没有客户负责人，默认选中第一个人员
                            $prUserSelect.val(allPersons[0].name);
                        }
                        
                        // 重新渲染下拉框
                        layui.form.render('select');
                        
                        // 初始化协同人选项（显示除客户负责人外的所有人）
                        if (typeof window.updateCollaboratorOptions === 'function') {
                            setTimeout(function() {
                                window.updateCollaboratorOptions(prUserName);
                            }, 100);
                        }
                        
                        // 渲染完成后，自动获取团队名称（如果已选中客户负责人）
                        setTimeout(function() {
                            var selectedPrUser = $prUserSelect.val();
                            if (selectedPrUser) {
                                // 直接调用获取团队名称的函数
                                if (typeof window.updateTeamNameByPrUser === 'function') {
                                    window.updateTeamNameByPrUser(selectedPrUser);
                                }
                            }
                        }, 100);
                        
                        $('#oper_user_input').val(result['msg']['oper_user']);
                        $('#country').val(result['msg']['country']);
                        $('#kh_username').val(result['msg']['kh_username']);
                        // 获取来源值用于更新运营端口选项（不自动设置询盘来源）
                        var sourceValue = result['msg']['source'] || "";
                        var $sourceSelect = $('#source');
                        // 更新运营端口选项并自动选择（不依赖于询盘来源是否匹配）
                        if (sourceValue) {
                            // 使用 setTimeout 确保 layui 已经初始化完成
                            setTimeout(function() {
                                // 触发 select 事件以更新运营端口选项列表
                                $sourceSelect.trigger('change');
                                
                                // 如果有返回的来源端口值，自动选择
                                var sourcePortValue = result['msg']['source_port'] || '';
                                if (sourcePortValue && typeof window.fillSourcePortBySourceName === 'function') {
                                    // 先更新选项列表
                                    window.fillSourcePortBySourceName(sourceValue);
                                    
                                    // 然后选择对应的端口
                                    setTimeout(function() {
                                        var $sourcePort = $('#source_port');
                                        // 尝试通过值匹配
                                        var portMatched = false;
                                        $sourcePort.find('option').each(function() {
                                            if ($(this).val() === sourcePortValue || $(this).val() === String(sourcePortValue)) {
                                                $sourcePort.val(sourcePortValue);
                                                portMatched = true;
                                                return false;
                                            }
                                        });
                                        if (portMatched) {
                                            layui.form.render('select');
                                            // 确保搜索功能正常
                                            setTimeout(function() {
                                                layui.form.render('select');
                                            }, 50);
                                        }
                                    }, 200);
                                } else {
                                    // 如果没有来源端口值，只更新选项列表
                                    if (typeof window.fillSourcePortBySourceName === 'function') {
                                        window.fillSourcePortBySourceName(sourceValue);
                                    }
                                }
                            }, 100);
                        }
                        
                        // 自动填充团队名称
                        var teamName = result['msg']['team_name'] || '';
                        if (teamName) {
                            var $teamSelect = $('#team_name');
                            // 尝试通过值匹配团队名称
                            var teamMatched = false;
                            $teamSelect.find('option').each(function() {
                                if ($(this).val() === teamName || $(this).text() === teamName) {
                                    $teamSelect.val($(this).val());
                                    teamMatched = true;
                                    return false;
                                }
                            });
                            if (teamMatched) {
                                layui.form.render('select');
                            }
                        }
                        
                        // 自动填充协同人（初始状态：显示协同人，不显示客户负责人）
                        var jointPersonIds = result['msg']['joint_person'] || [];
                        if (jointPersonIds && jointPersonIds.length > 0) {
                            // 确保协同人ID是字符串或数字格式
                            var jointPersonValues = jointPersonIds.map(function(id) {
                                return String(id);
                            });
                            // 使用 setTimeout 确保 xmSelect 已初始化
                            setTimeout(function() {
                                // 重新渲染 xmSelect 组件，设置初始值
                                if (window.collaboratorSelectInstance) {
                                    // 销毁旧实例
                                    if (window.collaboratorSelectInstance.destroy) {
                                        window.collaboratorSelectInstance.destroy();
                                    }
                                    // 获取更新后的协同人选项数据
                                    var collaboratorOptions = getCollaboratorOptionsData(prUserName);
                                    // 重新渲染并设置初始值
                                    window.collaboratorSelectInstance = xmSelect.render({
                                        el: '#collaboratorSelect',
                                        name: 'joint_person',
                                        layVerify: 'required',
                                        tips: '请选择协同人员',
                                        filterable: true,
                                        clickClose: false,
                                        initValue: jointPersonValues,
                                        data: collaboratorOptions
                                    });
                                }
                            }, 200);
                        } else {
                            // 如果没有初始协同人，也要更新选项
                            setTimeout(function() {
                                if (typeof window.updateCollaboratorOptions === 'function') {
                                    window.updateCollaboratorOptions(prUserName);
                                }
                            }, 200);
                        }
                        
                        // 无论客户是否成交，都不自动填充历史订单产品信息，让用户手动选择产品
                        // 确保产品明细表格始终保持只有一行空行的初始状态
                        var $tbody = $('#productTableBody');
                        var productOptions = window.productOptions || $('select[name="product_name[]"]').first().html();
                        var managerOptions = window.managerOptions || $('select[name="product_manager[]"]').first().html();
                        
                        // 清空所有现有的产品明细行
                        $tbody.empty();
                        
                        // 添加一行空的输入行（初始状态）
                        var emptyRow = document.createElement('tr');
                        emptyRow.innerHTML =
                            '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                            '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                            '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                            '<td><select name="unit[]" lay-search lay-verify="required">' + unitOptions + '</select></td>' +
                            '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                            '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                            '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                            '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                            '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
                        $tbody.append(emptyRow);
                        
                        // 重新渲染下拉框
                        layui.form.render('select');
                        
                        // 对产品名称下拉选项调用 boldCategory，使分类名加粗
                        $tbody.find('select[name="product_name[]"]').each(function() {
                            boldCategory($(this));
                        });
                        
                        // 重置金额字段
                        $('#money').val('0.00');
                        $('#profit').val('0.00');
                        $('#margin_rate').val('0.00');
                    }
                    // 显示提示信息，如果是成交客户，在绿色消息后面添加红色字符
                    var messageHtml = result['msg']['msg'] || '';
                    if (result['msg']['is_success'] == 1 || result['msg']['is_success'] === true) {
                        messageHtml += '<span style="color: red;">由于该客户已成交，询盘来源请选择返单，运营端口根据实际情况选择</span>';
                    }
                    $('#checklabel').html(messageHtml);
                },
                error: function () {
                    alert("异常！");
                }
            });
        }
    </script>

    <div class="admin-main layui-anim layui-anim-upbit" ng-app="hd" ng-controller="ctrl">
        <form class="layui-form layui-form-pane">
            <!-- 客户联系方式 -->
            <div class="layui-form-item">
                <label class="layui-form-label">联系方式<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="contact" onchange="changeyewu()" onblur="changeyewu()" name="contact" lay-verify="required"
                        placeholder="请输入客户联系方式（只能输入您的客户或协同人客户的电话）" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-4">
                    <label id="checklabel"></label>
                </div>
            </div>
            <!-- 省市选择 -->
            <div class="layui-form-item">
                <label class="layui-form-label">所在省市<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <select name="province" id="province" lay-search lay-filter="province_select" lay-verify="required">
                                <option value="">请选择省份</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <select name="city" id="city" lay-search lay-filter="city" lay-verify="required">
                                <option value="">请先选择省份</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 收货地址 -->
            <div class="layui-form-item">
                <label class="layui-form-label">收货地址<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <textarea id="country" name="country" placeholder="请输入发货详细地址" class="layui-textarea" lay-verify="required"></textarea>
                </div>
            </div>
            <!-- 用户属性选择 -->
            <div class="layui-form-item">
                <label class="layui-form-label">用户属性<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="customer_type_flag" id="customer_type_flag" lay-verify="required" lay-filter="customer_type_flag">
                        <option value="">请选择用户属性</option>
                        <option value="0">公司</option>
                        <option value="1">个人</option>
                    </select>
                </div>
            </div>
            <!-- 原有"客户公司"表单项，增加下拉列表容器 -->
            <div class="layui-form-item" id="client_company_item" style="display: none;">
                <label class="layui-form-label">客户公司<span style="color:red;">*</span></label>
                <div class="layui-input-4" style="position: relative;"><!-- 替换：增加 position: relative; 以定位下拉列表 -->
                    <input type="text" id="client_company" name="client_company" value=""
                        placeholder="请输入客户公司" class="layui-input" lay-verify="required">
                    <div id="companyList" class="suggestion-list" 
                        style="position:absolute; top:38px; left:0; z-index:9999; background:#FFF; border:1px solid #ccc; display:none;"><!-- 新增：联想下拉列表容器 -->
                    </div>
                </div>
            </div>
        
            <div class="layui-form-item">
                <label class="layui-form-label">客户负责人<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="pr_user" id="pr_user" lay-verify="required" lay-search="" lay-filter="pr_user">
                        <option value="">请选择客户负责人</option>
                    </select>
                </div>
            </div>
            <!-- 询盘来源 -->
            <div class="layui-form-item">
                <label class="layui-form-label">询盘来源<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="source" id="source" lay-filter="kh_status" lay-search="" lay-verify="required">
                        <option value="">请选择询盘来源</option>
                        {volist name='sourceList' id='vo'}
                        <option value="{$vo|htmlentities}">{$vo|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 运营端口：可搜索单选下拉（根据询盘来源动态更新） -->
            <div class="layui-form-item">
                <label class="layui-form-label">运营端口<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="source_port" id="source_port" lay-search lay-verify="required">
                        <option value="">请先选择询盘来源（选择后可搜索端口）</option>
                    </select>
                </div>
            </div>
            <!-- 收款账户 -->
            <div class="layui-form-item">
                <label class="layui-form-label">收款账户<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="bank_account" id="bank_account" lay-verify="required" lay-search="">
                        <option value="">请选择收款账户</option>
                        {volist name="accountList" id="acc"}
                            <option value="{$acc.id}">{$acc.account|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
           
            <!-- 协同人多选下拉 -->
            <div class="layui-form-item">
                <label class="layui-form-label">协同人</label>
                <div class="layui-input-4">
                    <div id="collaboratorSelect"></div>
                </div>
            </div>
            <!-- 团队名称 -->
            <div class="layui-form-item">
                <label class="layui-form-label">团队名称<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="team_name" id="team_name" lay-verify="required" lay-search="">
                        <option value="">请选择团队名称</option>
                        {volist name='teamList' id='vo'}
                        <option value="{$vo}" {if $vo==$team_name} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 客户性质 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户性质<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="customer_type" id="customer_type" lay-verify="required" lay-search="">
                        <option value="">请选择客户性质</option>
                        {volist name='customer_type' id='vo'}
                        <option value="{$vo}" {if $vo==$customer_type} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 成交时间 -->
            <div class="layui-form-item">
                <label class="layui-form-label">成交时间<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="orderTime" name="order_time" placeholder="请输入成交时间" class="layui-input" lay-verify="required" autocomplete="off" readonly>
                </div>
            </div>
            <!-- 产品明细表格 -->
            <div class="layui-form-item">
                <label class="layui-form-label">产品明细<span style="color:red;">*</span></label>
                <div class="layui-input-block">
                    <table id="product-table" class="layui-table">
                        <thead>
                            <tr>
                                <th>产品名称<span style="color:red;">*</span></th>
                                <th>产品经理<span style="color:red;">*</span></th>
                                <th>规格型号</th>
                                <th>单位<span style="color:red;">*</span></th>
                                <th>数量<span style="color:red;">*</span></th>
                                <th>销售单价<span style="color:red;">*</span></th>
                                <th>销售价合计<span style="color:red;">*</span></th>
                                <th>进价合计<span style="color:red;">*</span></th>
                                <th>利润<span style="color:red;">*</span></th>
                                <th>行备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- 默认提供一行空的输入行（带下拉选择产品名称） -->
                            <tr>
                                <td>
                                    <select name="product_name[]" lay-search lay-verify="required">
                                        <option value="">请选择产品名称</option>
                                        {volist name="productList" id="vo"}
                                        <option value="{$vo.id}">{$vo.product_name} ({$vo.category_name|default='无'})
                                        </option>
                                        {/volist}
                                    </select>
                                </td>
                                <td>
                                    <select name="product_manager[]" lay-search lay-verify="required">
                                        <option value="">请选择产品经理</option>
                                        <!-- 遍历产品经理列表 -->
                                        {volist name="managerList" id="vo"}
                                        <option value="{$vo.admin_id}">{$vo.username}</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><input type="text" name="spec_model[]" class="layui-input"></td>
                                <td>
                                    <select name="unit[]" lay-search lay-verify="required">
                                        <option value="">请选择单位</option>

                                        <!-- 数量单位 -->
                                        <option value="台">台</option>
                                        <option value="套">套</option>
                                        <option value="件">件</option>
                                        <option value="个">个</option>
                                        <option value="批">批</option>
                                        <option value="根">根</option>
                                        <option value="米">米</option>
                                        <option value="吨">吨</option>
                                        <option value="箱">箱</option>
                                        <option value="包">包</option>
                                        <option value="卷">卷</option>
                                        <option value="片">片</option>
                                        <option value="块">块</option>
                                        <option value="组">组</option>
                                        <option value="束">束</option>
                                        <option value="副">副</option>
                                        <option value="双">双</option>
                                        <option value="袋">袋</option>
                                        <option value="桶">桶</option>
                                        <option value="袋">袋</option>
                                        <option value="支">支</option>

                                        <!-- 重量单位 -->
                                        <option value="kg">kg</option>
                                        <option value="g">g</option>
                                        <option value="t">t</option>
                                        <option value="吨">吨</option>
                                        <option value="千克">千克</option>
                                        <option value="公斤">公斤</option>

                                        <!-- 长度单位 -->
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="m">m</option>
                                        <option value="km">km</option>
                                        <option value="丝">丝</option>

                                        <!-- 面积单位 -->
                                        <option value="㎡">㎡</option>
                                        <option value="cm²">cm²</option>
                                        <option value="mm²">mm²</option>

                                        <!-- 体积单位 -->
                                        <option value="L">L</option>
                                        <option value="m³">m³</option>
                                        <option value="ml">ml</option>

                                        <!-- 工业通用单位（机械行业常用） -->
                                        <option value="套装">套装</option>
                                        <option value="车">车</option>
                                        <option value="架">架</option>
                                        <option value="头">头</option>
                                        <option value="盘">盘</option>
                                        <option value="排">排</option>
                                        <option value="片">片</option>
                                        <option value="平方">平方</option>
                                        <option value="立方">立方</option>
                                        <option value="节">节</option>
                                        <option value="段">段</option>
                                        <option value="条">条</option>

                                        <!-- 包装单位 -->
                                        <option value="箱">箱</option>
                                        <option value="木箱">木箱</option>
                                        <option value="纸箱">纸箱</option>
                                        <option value="托盘">托盘</option>
                                        <option value="袋">袋</option>
                                        <option value="编织袋">编织袋</option>

                                        <!-- 机械行业特殊单位 -->
                                        <option value="卷">卷</option>
                                        <option value="盘">盘</option>
                                        <option value="板">板</option>
                                        <option value="片">片</option>
                                        <option value="块">块</option>
                                        <option value="柱">柱</option>
                                        <option value="瓶">瓶</option>
                                        <option value="罐">罐</option>

                                    </select>
                                </td>
                                <td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number">
                                </td>
                                <td><input type="number" name="unit_price[]" class="layui-input"
                                        lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="total_price[]" class="layui-input" readonly></td>
                                <td><input type="number" name="purchase_price[]" class="layui-input"
                                        lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>
                                <td><input type="text" name="item_remark[]" class="layui-input"></td>
                                <td><button type="button"
                                        class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- 新增一行按钮 -->
                    <button type="button" id="addRow" class="layui-btn layui-btn-normal">新增一行</button>
                </div>
            </div>
            <!-- 费用和金额字段 -->
            <div class="layui-form-item">
                <label class="layui-form-label">估算运费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="shipping_cost" name="shipping_cost" lay-verify="required"
                        placeholder="请输入估算运费" class="layui-input">
                </div>
            </div>
            <!-- 票种性质 -->
            <div class="layui-form-item">
                <label class="layui-form-label">票种性质<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="invoice_type" id="invoice_type" lay-verify="required" lay-filter="invoice_type">
                        <option value="">请选择票种性质</option>
                        <option value="普票">普票</option>
                        <option value="专票">专票</option>
                        <option value="不开票">不开票</option>
                    </select>
                </div>
            </div>
            <!-- 票种/票金额 -->
            <div class="layui-form-item" id="invoice_amount_item" style="display: none;">
                <label class="layui-form-label">票种/票金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="invoice_amount" name="invoice_amount" lay-verify=""
                        placeholder="请输入开票金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">税费金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="tax_amount" name="tax_amount" lay-verify="required" placeholder="请输入税费金额"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">调试费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="debugging_cost" name="debugging_cost" lay-verify="required"
                        placeholder="请输入调试费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">佣金<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="sales_commission" name="sales_commission" lay-verify="required"
                        placeholder="请输入佣金" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">分成备注<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="split_remarks" name="split_remarks" lay-verify="required"
                        placeholder="请输入分成备注" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">已收款金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="amount_received" name="amount_received" lay-verify="required"
                        placeholder="请输入已收款金额" class="layui-input">
                </div>
            </div>
            <!-- 订单金额、利润、利润率 -->
            <div class="layui-form-item">
                <label class="layui-form-label">订单金额(￥)<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="money" name="money" lay-verify="number|required" placeholder="请输入订单总金额"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润(￥)<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="profit" name="profit" lay-verify="required" placeholder="请输入利润"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润率(%)<span style="color:red;">*</span></label>
                <div class="layui-input-4" style="position: relative;">
                    <input type="text" id="margin_rate" name="margin_rate" lay-verify="required" placeholder="请输入利润率"
                        class="layui-input">
                    <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);">%</span>
                </div>
            </div>
            <!-- 客户微信回执图 -->
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>客户微信回执图</label>
                <div class="layui-input-4">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="upload_wechat_receipt">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="wechat_receipt_preview" style="max-width: 200px; max-height: 200px; display: none;">
                            <p id="wechat_receipt_text"></p>
                            <input type="hidden" name="wechat_receipt_image" id="wechat_receipt_image" value="" lay-verify="required">
                        </div>
                    </div>
                </div>
            </div>
            <!-- 产品询盘分配图 -->
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>产品询盘分配图</label>
                <div class="layui-input-4">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="upload_inquiry_assign">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="inquiry_assign_preview" style="max-width: 200px; max-height: 200px; display: none;">
                            <p id="inquiry_assign_text"></p>
                            <input type="hidden" name="inquiry_assign_image" id="inquiry_assign_image" value="" lay-verify="required">
                        </div>
                    </div>
                </div>
            </div>
            <!-- 备注 -->
            <!-- <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-4">
                    <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
                </div>
            </div> -->
            <!-- 提交按钮 -->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
                </div>
            </div>
        </form>
    </div>
    {include file="common/foot"/}

    <script>
        layui.use(['form', 'layer', 'laydate', 'upload'], function () {
            var form = layui.form,
                layer = layui.layer,
                $ = layui.jquery,
                laydate = layui.laydate,
                upload = layui.upload;
            // 日期控件初始化
            laydate.render({
                elem: '#orderTime',
                type: 'datetime',
                trigger: 'click',
                format: 'yyyy-MM-dd HH:mm:ss'
            });
            // 自定义验证规则（数字校验）
            form.verify({
                number: function (value) {
                    if (!/^\d+(\.\d+)?$/.test(value)) {
                        return '请输入有效的数字';
                    }
                }
            });
            // 初始化协同人多选下拉
            var collaboratorData = {$collaboratorList|raw};
            // 将协同人数据保存到全局，以便 changeyewu 函数可以访问
            window.collaboratorData = collaboratorData;
            // 将 xmSelect 实例保存到全局，以便 changeyewu 函数可以访问
            window.collaboratorSelectInstance = xmSelect.render({
                el: '#collaboratorSelect',
                name: 'joint_person',
                // layVerify: 'required',
                tips: '请选择协同人员',
                filterable: true,
                clickClose: false,
                data: collaboratorData
            });
            // 渲染现有的下拉框（包括产品名称、询盘来源等）
            form.render('select');

            // 初始化省市联动下拉框
            var $provinceSelect = $('#province');
            var $citySelect = $('#city');
            
            // 填充省份下拉框
            $.each(chinaProvincesCities, function(provinceName, cities) {
                $provinceSelect.append('<option value="' + provinceName + '">' + provinceName + '</option>');
            });
            form.render('select');
            
            // 保存省和市的固定前缀
            var provinceCityPrefix = '';
            var $countryInput = $('#country');
            
            // 更新收货地址的函数
            function updateCountryAddress() {
                var selectedProvince = $provinceSelect.val();
                var selectedCity = $citySelect.val();
                
                if (selectedProvince && selectedCity) {
                    // 省和市都选择了，保存旧的前缀用于提取用户输入
                    var oldPrefix = provinceCityPrefix;
                    var newPrefix = selectedProvince + selectedCity;
                    provinceCityPrefix = newPrefix;
                    
                    // 获取当前收货地址
                    var currentValue = $countryInput.val();
                    var userInput = '';
                    
                    // 如果当前值以旧的省和市开头，保留后面的用户输入
                    if (oldPrefix && currentValue.indexOf(oldPrefix) === 0) {
                        userInput = currentValue.substring(oldPrefix.length);
                    } else if (currentValue) {
                        // 如果当前值不是以旧的省和市开头，但有内容
                        // 检查是否以新的省和市开头
                        if (currentValue.indexOf(newPrefix) === 0) {
                            userInput = currentValue.substring(newPrefix.length);
                        } else {
                            // 保留全部内容作为用户输入
                            userInput = currentValue;
                        }
                    }
                    
                    // 设置收货地址：省和市 + 用户输入
                    var newValue = newPrefix + userInput;
                    $countryInput.val(newValue);
                    
                    // 设置光标位置到省和市之后
                    setTimeout(function() {
                        var cursorPos = newPrefix.length;
                        if ($countryInput[0].setSelectionRange) {
                            $countryInput[0].setSelectionRange(cursorPos, cursorPos);
                        } else if ($countryInput[0].createTextRange) {
                            var range = $countryInput[0].createTextRange();
                            range.collapse(true);
                            range.moveEnd('character', cursorPos);
                            range.moveStart('character', cursorPos);
                            range.select();
                        }
                        $countryInput.focus();
                    }, 10);
                } else {
                    // 省或市未选择，保存旧的前缀用于检查
                    var oldPrefix = provinceCityPrefix;
                    provinceCityPrefix = '';
                    
                    // 如果当前值以之前的省和市开头，移除省和市部分，保留用户输入
                    var currentValue = $countryInput.val();
                    if (currentValue && oldPrefix && currentValue.indexOf(oldPrefix) === 0) {
                        // 保留省和市之后的内容
                        var userInput = currentValue.substring(oldPrefix.length);
                        $countryInput.val(userInput);
                    }
                }
            }
            
            // 省份选择变化时，更新城市下拉框
            form.on('select(province_select)', function(data) {
                var selectedProvince = data.value;
                $citySelect.empty();
                
                if (selectedProvince && chinaProvincesCities[selectedProvince]) {
                    var cities = chinaProvincesCities[selectedProvince];
                    $citySelect.append('<option value="">请选择城市</option>');
                    $.each(cities, function(index, cityName) {
                        $citySelect.append('<option value="' + cityName + '">' + cityName + '</option>');
                    });
                } else {
                    $citySelect.append('<option value="">请先选择省份</option>');
                }
                form.render('select');
                
                // 省份选择变化后，更新收货地址（如果城市已选择，会更新；如果省份清空，会移除省和市）
                updateCountryAddress();
            });
            
            // 城市选择变化时，更新收货地址
            form.on('select(city)', function(data) {
                updateCountryAddress();
            });
            
            // 保护收货地址中的省和市部分，防止修改
            $countryInput.on('input', function(e) {
                var currentValue = $(this).val();
                var cursorPos = this.selectionStart || 0;
                
                // 如果省和市已选择
                if (provinceCityPrefix) {
                    // 如果当前值不以省和市开头，说明用户删除了省和市，需要恢复
                    if (currentValue.indexOf(provinceCityPrefix) !== 0) {
                        // 提取用户输入的部分（省和市之后的内容）
                        var userInput = '';
                        
                        // 如果当前值长度小于省和市前缀长度，说明用户删除了省和市
                        if (currentValue.length < provinceCityPrefix.length) {
                            userInput = '';
                        } else {
                            // 尝试从当前位置提取用户输入
                            // 如果当前值包含省和市的一部分，提取后面的内容
                            var prefixIndex = currentValue.indexOf(provinceCityPrefix);
                            if (prefixIndex >= 0) {
                                userInput = currentValue.substring(prefixIndex + provinceCityPrefix.length);
                            } else {
                                // 如果完全不包含省和市，保留全部作为用户输入
                                userInput = currentValue;
                            }
                        }
                        
                        // 恢复省和市前缀
                        var newValue = provinceCityPrefix + userInput;
                        $(this).val(newValue);
                        
                        // 设置光标位置到省和市之后
                        setTimeout(function() {
                            var newCursorPos = provinceCityPrefix.length;
                            if ($countryInput[0].setSelectionRange) {
                                $countryInput[0].setSelectionRange(newCursorPos, newCursorPos);
                            }
                        }, 0);
                        return false;
                    }
                    
                    // 如果光标在省和市之前，移动到省和市之后
                    if (cursorPos < provinceCityPrefix.length) {
                        setTimeout(function() {
                            if ($countryInput[0].setSelectionRange) {
                                $countryInput[0].setSelectionRange(provinceCityPrefix.length, provinceCityPrefix.length);
                            }
                        }, 0);
                    }
                }
            });
            
            // 监听键盘事件，防止在省和市之前输入
            $countryInput.on('keydown', function(e) {
                if (provinceCityPrefix) {
                    var cursorPos = this.selectionStart || 0;
                    
                    // 如果光标在省和市之前，且不是方向键，阻止输入
                    if (cursorPos < provinceCityPrefix.length) {
                        // 允许方向键、删除键等
                        var allowedKeys = [37, 38, 39, 40, 35, 36, 8, 46]; // 方向键、Home、End、Backspace、Delete
                        if (allowedKeys.indexOf(e.keyCode) === -1) {
                            e.preventDefault();
                            // 将光标移到省和市之后
                            setTimeout(function() {
                                if ($countryInput[0].setSelectionRange) {
                                    $countryInput[0].setSelectionRange(provinceCityPrefix.length, provinceCityPrefix.length);
                                }
                            }, 0);
                            return false;
                        }
                    }
                    
                    // 如果尝试删除省和市部分，阻止删除
                    if (e.keyCode === 8 || e.keyCode === 46) { // Backspace 或 Delete
                        var start = this.selectionStart || 0;
                        var end = this.selectionEnd || 0;
                        
                        // 如果选中的范围包含省和市部分，阻止删除
                        if (start < provinceCityPrefix.length || end <= provinceCityPrefix.length) {
                            e.preventDefault();
                            // 将光标移到省和市之后
                            setTimeout(function() {
                                if ($countryInput[0].setSelectionRange) {
                                    $countryInput[0].setSelectionRange(provinceCityPrefix.length, provinceCityPrefix.length);
                                }
                            }, 0);
                            return false;
                        }
                    }
                }
            });
            
            // 监听鼠标点击，防止在省和市之前定位光标
            $countryInput.on('click', function(e) {
                if (provinceCityPrefix) {
                    setTimeout(function() {
                        var cursorPos = $countryInput[0].selectionStart || 0;
                        if (cursorPos < provinceCityPrefix.length) {
                            if ($countryInput[0].setSelectionRange) {
                                $countryInput[0].setSelectionRange(provinceCityPrefix.length, provinceCityPrefix.length);
                            }
                        }
                    }, 0);
                }
            });
            
        // 对初始产品名称下拉选项调用 boldCategory，使分类名加粗
        // 注意：boldCategory 函数已移到全局作用域
        setTimeout(function() {
            boldCategory($('select[name="product_name[]"]'));
        }, 100);

        // 动态根据询盘来源过滤运营人员和运营端口选项
        var yyList = {$yyList|raw};
        var shopList = {$shopList|raw};  // 店铺列表分组数据：{ 来源名称: [ {id:..., name:...}, ... ], ... }
        
        // 将函数定义到全局作用域，以便 changeyewu 函数可以访问
        window.fillSourcePortBySourceName = function(sourceName) {
            var shops = shopList[sourceName] || [];
            var $sourcePort = $('#source_port');
            $sourcePort.empty();
            if (shops.length > 0) {
                $sourcePort.append('<option value="">请选择运营端口（支持搜索）</option>');
                $.each(shops, function (index, shop) {
                    $sourcePort.append('<option value="' + shop.id + '">' + shop.name + '</option>');
                });
            } else {
                $sourcePort.append('<option value="">该来源暂无店铺数据</option>');
            }
            // 确保重新渲染select，使lay-search搜索功能生效
            form.render('select');
            // 延迟一下确保渲染完成
            setTimeout(function() {
                form.render('select');
            }, 50);
        };
        
        form.on('select(kh_status)', function (data) {
            var sourceName = $(data.elem).find("option:selected").text();
            var users = yyList[sourceName] || [];
            var $oper = $('select[name="oper_user"]');
            $oper.empty().append('<option value="">请选择运营人员</option>');
            $.each(users, function (index, user) {
                $oper.append('<option value="' + user.id + '">' + user.name + '</option>');
            });
            // 更新运营端口选项
            if (typeof window.fillSourcePortBySourceName === 'function') {
                window.fillSourcePortBySourceName(sourceName);
            }
            form.render('select');
        });
        
        // 用户属性选择变化时的处理
        form.on('select(customer_type_flag)', function (data) {
            var customerTypeFlag = data.value;
            var $clientCompanyItem = $('#client_company_item');
            var $clientCompanyInput = $('#client_company');
            
            if (customerTypeFlag === '0') {
                // 选择"公司"：显示客户公司字段并设置为必填
                $clientCompanyItem.show();
                $clientCompanyInput.attr('lay-verify', 'required');
                // 重新渲染表单验证
                form.render();
            } else if (customerTypeFlag === '1') {
                // 选择"个人"：隐藏客户公司字段并移除必填验证
                $clientCompanyItem.hide();
                $clientCompanyInput.removeAttr('lay-verify');
                $clientCompanyInput.val(''); // 清空值
                $('#companyList').hide(); // 隐藏下拉列表
                // 重新渲染表单验证
                form.render();
            }
        });
        
        // 票种性质选择变化时的处理
        form.on('select(invoice_type)', function (data) {
            var invoiceType = data.value;
            var $invoiceAmountItem = $('#invoice_amount_item');
            var $invoiceAmountInput = $('#invoice_amount');
            
            if (invoiceType === '不开票') {
                // 选择"不开票"：隐藏票种金额字段并移除必填验证
                $invoiceAmountItem.hide();
                $invoiceAmountInput.removeAttr('lay-verify');
                $invoiceAmountInput.val(''); // 清空值
                // 重新渲染表单验证
                form.render();
            } else if (invoiceType === '普票' || invoiceType === '专票') {
                // 选择"普票"或"专票"：显示票种金额字段并设置为必填
                $invoiceAmountItem.show();
                $invoiceAmountInput.attr('lay-verify', 'required');
                // 重新渲染表单验证
                form.render();
            }
        });
        
        // 根据客户负责人更新团队名称的通用函数（移到全局作用域，以便 changeyewu 函数可以访问）
        window.updateTeamNameByPrUser = function(prUser) {
            var $teamSelect = $('#team_name');
            
            // 如果客户负责人为空，清空团队名称
            if (!prUser || prUser === '') {
                $teamSelect.val('');
                layui.form.render('select');
                return;
            }
            
            // 通过AJAX获取团队名称
            $.ajax({
                url: "{:url('Order/getTeamByPrUser')}",
                type: 'POST',
                data: { pr_user: prUser },
                dataType: 'json',
                success: function(result) {
                    if (result['code'] == 1 && result['data'] && result['data']['team_name']) {
                        var teamName = result['data']['team_name'];
                        // 尝试通过值或文本匹配团队名称
                        var teamMatched = false;
                        $teamSelect.find('option').each(function() {
                            if ($(this).val() === teamName || $(this).text() === teamName) {
                                $teamSelect.val($(this).val());
                                teamMatched = true;
                                return false;
                            }
                        });
                        if (teamMatched) {
                            layui.form.render('select');
                        } else {
                            // 如果下拉框中没有匹配的团队名称，可以选择提示用户或保持原值
                            layui.layer.msg('该客户负责人的团队"' + teamName + '"不在可选列表中', { icon: 0, time: 2000 });
                        }
                    } else {
                        // 未找到对应的团队（静默处理，不提示用户）
                        // layui.layer.msg('未找到该客户负责人对应的团队', { icon: 0, time: 2000 });
                    }
                },
                error: function() {
                    // 静默处理错误，避免影响用户体验
                    // layui.layer.msg('获取团队名称失败，请稍后重试', { icon: 2, time: 2000 });
                }
            });
        };
        
        // 根据选中的客户负责人更新协同人选项的函数（移到全局作用域）
        window.getCollaboratorOptionsData = function(selectedPrUserName) {
            if (!window.allPersonsList || window.allPersonsList.length === 0) {
                return window.collaboratorData || [];
            }
            
            // 构建协同人选项：包括除选中客户负责人外的所有人
            var collaboratorOptions = [];
            window.allPersonsList.forEach(function(person) {
                // 排除被选为客户负责人的人
                if (person.name !== selectedPrUserName) {
                    // 从collaboratorData中找到对应的完整数据
                    var found = false;
                    if (window.collaboratorData && window.collaboratorData.length > 0) {
                        for (var i = 0; i < window.collaboratorData.length; i++) {
                            if (window.collaboratorData[i].name === person.name) {
                                collaboratorOptions.push(window.collaboratorData[i]);
                                found = true;
                                break;
                            }
                        }
                    }
                    // 如果在collaboratorData中找不到，使用person的数据
                    if (!found && person.id) {
                        collaboratorOptions.push({
                            name: person.name,
                            value: person.id
                        });
                    }
                }
            });
            
            return collaboratorOptions.length > 0 ? collaboratorOptions : (window.collaboratorData || []);
        };
        
        // 更新协同人选项的函数（移到全局作用域）
        window.updateCollaboratorOptions = function(selectedPrUserName) {
            if (!window.collaboratorSelectInstance) {
                return;
            }
            
            // 获取更新后的协同人选项数据
            var collaboratorOptions = window.getCollaboratorOptionsData(selectedPrUserName);
            
            // 获取当前选中的协同人值
            var currentValues = [];
            if (window.collaboratorSelectInstance && window.collaboratorSelectInstance.getValue) {
                var currentValue = window.collaboratorSelectInstance.getValue();
                if (currentValue && currentValue.length > 0) {
                    currentValues = currentValue;
                }
            }
            
            // 过滤掉被选为客户负责人的人（如果他们在当前选中值中）
            var filteredValues = [];
            if (selectedPrUserName && window.allPersonsList) {
                // 找到被选为客户负责人的人的ID
                var selectedPrUserId = null;
                for (var i = 0; i < window.allPersonsList.length; i++) {
                    if (window.allPersonsList[i].name === selectedPrUserName) {
                        selectedPrUserId = window.allPersonsList[i].id;
                        break;
                    }
                }
                
                // 过滤当前选中值，排除被选为客户负责人的人
                currentValues.forEach(function(val) {
                    if (String(val) !== String(selectedPrUserId)) {
                        filteredValues.push(val);
                    }
                });
            } else {
                filteredValues = currentValues;
            }
            
            // 销毁旧实例
            if (window.collaboratorSelectInstance.destroy) {
                window.collaboratorSelectInstance.destroy();
            }
            
            // 重新渲染协同人选择器
            window.collaboratorSelectInstance = xmSelect.render({
                el: '#collaboratorSelect',
                name: 'joint_person',
                tips: '请选择协同人员',
                filterable: true,
                clickClose: false,
                initValue: filteredValues,
                data: collaboratorOptions
            });
        };
        
        // 客户负责人选择变化时的处理 - 自动填充团队名称和更新协同人选项
        form.on('select(pr_user)', function (data) {
            var selectedPrUserName = data.value;
            // 更新团队名称
            window.updateTeamNameByPrUser(selectedPrUserName);
            // 更新协同人选项
            window.updateCollaboratorOptions(selectedPrUserName);
        });

        // **为新增产品行准备选项HTML** 
        // 获取初始产品名称下拉的所有选项HTML（包括"请选择"和产品列表）
        var productOptions = $('select[name="product_name[]"]').first().html();
        // 保存到全局作用域，以便 changeyewu 函数可以访问
        window.productOptions = productOptions;

        // 获取初始产品经理下拉的所有选项 HTML  (新增)
        var managerOptions = $('select[name="product_manager[]"]').first().html();
        // 保存到全局作用域，以便 changeyewu 函数可以访问
        window.managerOptions = managerOptions;

        // 获取初始单位下拉的所有选项 HTML（写死的那几个单位）
        var unitOptions = $('select[name="unit[]"]').first().html();
        window.unitOptions = unitOptions;


        // 页面加载时，初始化产品明细表格：清空所有行，只保留一行空行
        function initProductTable() {
            var $tbody = $('#productTableBody');
            // 清空所有现有的产品明细行
            $tbody.empty();
            
            // 添加一行空的输入行（初始状态）
            var emptyRow = document.createElement('tr');
            emptyRow.innerHTML =
                '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                '<td><select name="unit[]" lay-search lay-verify="required">' + unitOptions + '</select></td>' +
                '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
            $tbody.append(emptyRow);
            
            // 重新渲染下拉框
            form.render('select');
            
            // 对产品名称下拉选项调用 boldCategory，使分类名加粗
            $tbody.find('select[name="product_name[]"]').each(function() {
                boldCategory($(this));
            });
            
            // 重置金额字段
            $('#money').val('0.00');
            $('#profit').val('0.00');
            $('#margin_rate').val('0.00');
        }
        
        // 页面加载完成后初始化产品明细表格
        $(document).ready(function() {
            initProductTable();
        });

        // 新增一行产品明细
        $('#addRow').on('click', function () {
            var $tbody = $('#productTableBody');
            // 创建新<tr>元素
            var newRow = document.createElement('tr');
            newRow.innerHTML =
                '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                '<td><select name="unit[]" lay-search lay-verify="required">' + unitOptions + '</select></td>' +
                '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
            $tbody.append(newRow);
            // 重新渲染新添加的下拉框为 LayUI 风格
            form.render('select');
            // （如果有对产品名称下拉选项的特殊处理，如 boldCategory，可在此对 newRow 的 product_name 下拉调用）
        });

        // 删除产品行
        $('#productTableBody').on('click', '.delete-row', function () {
            $(this).closest('tr').remove();
            updateTotals();  // 删除后更新总计
        });

        // 更新单行的销售合计和子项利润
        function updateRow($tr) {
            var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
            var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
            var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
            var total = qty * unitPrice;
            var profit = total - purchase;
            $tr.find('input[name="total_price[]"]').val(total.toFixed(2));
            $tr.find('input[name="sub_profit[]"]').val(profit.toFixed(2));
        }

        // 更新所有产品行的总金额、总利润和利润率
        function updateTotals() {
            var sumTotal = 0, sumProfit = 0;
            // 遍历每一行产品，计算总金额和总利润（已有逻辑）
            $('#productTableBody tr').each(function () {
                var $tr = $(this);
                var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                var lineTotal = qty * unitPrice;
                var lineProfit = lineTotal - purchase;
                sumTotal += lineTotal;
                sumProfit += lineProfit;
            });
            // 更新订单总金额字段
            $('#money').val(sumTotal.toFixed(2));

            // 读取其他费用字段并计算最终利润
            var shippingCost = parseFloat($('#shipping_cost').val()) || 0;
            var taxAmount = parseFloat($('#tax_amount').val()) || 0;
            var debuggingCost = parseFloat($('#debugging_cost').val()) || 0;
            var salesCommission = parseFloat($('#sales_commission').val()) || 0;
            var finalProfit = sumProfit - shippingCost - taxAmount - debuggingCost - salesCommission;
            $('#profit').val(finalProfit.toFixed(2));

            // 计算利润率并更新字段（避免除以 0）
            var marginRate = 0;
            if (sumTotal > 0) {
                marginRate = (finalProfit / sumTotal) * 100;
            }
            $('#margin_rate').val(marginRate.toFixed(2));
        }


        // 当数量、单价或进价改变时，实时更新对应行和总计
        $('#productTableBody').on('input', 'input[name="qty[]"], input[name="unit_price[]"], input[name="purchase_price[]"]', function () {
            var $row = $(this).closest('tr');
            updateRow($row);
            updateTotals();
        });

            // 页面加载完成时，自动计算初始订单金额、利润和利润率
            updateTotals();

            // 当运费、税费、调试费或佣金字段的值发生变化时，实时更新总计、利润和利润率
            $('#shipping_cost, #tax_amount, #debugging_cost, #sales_commission').on('input', function () {
                updateTotals();
            });

            // 图片压缩函数
            function compressImage(file, maxWidth, maxHeight, quality, callback) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        
                        // 计算压缩后的尺寸
                        var width = img.width;
                        var height = img.height;
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = height * (maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = width * (maxHeight / height);
                                    height = maxHeight;
                                }
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 绘制压缩后的图片
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为blob
                        canvas.toBlob(function(blob) {
                            callback(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // 手动上传压缩后的图片
            function uploadCompressedImage(blob, fileName, uploadUrl, progressCallback, successCallback, errorCallback) {
                var formData = new FormData();
                // 确保文件名有正确的扩展名
                if (!fileName.toLowerCase().endsWith('.jpg') && !fileName.toLowerCase().endsWith('.jpeg')) {
                    fileName = fileName.replace(/\.[^/.]+$/, '') + '.jpg';
                }
                formData.append('file', blob, fileName);
                
                var xhr = new XMLHttpRequest();
                
                // 上传进度
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        var percent = Math.round((e.loaded / e.total) * 100);
                        if (progressCallback) progressCallback(percent);
                    }
                }, false);
                
                // 上传完成
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        try {
                            var res = JSON.parse(xhr.responseText);
                            if (successCallback) successCallback(res);
                        } catch(e) {
                            if (errorCallback) errorCallback('响应解析失败: ' + e.message);
                        }
                    } else {
                        if (errorCallback) errorCallback('上传失败，状态码：' + xhr.status + '，响应：' + xhr.responseText);
                    }
                }, false);
                
                // 上传错误
                xhr.addEventListener('error', function() {
                    if (errorCallback) errorCallback('网络错误');
                }, false);
                
                xhr.open('POST', uploadUrl);
                // 不手动设置 Content-Type，让浏览器自动设置 multipart/form-data
                // 这样 ThinkPHP 才能正确解析文件
                xhr.send(formData);
            }

            // 客户微信回执图上传 - 使用隐藏的input
            var wechatReceiptInput = $('<input type="file" accept="image/*" style="display:none;" id="wechat_receipt_input">');
            $('body').append(wechatReceiptInput);
            
            $('#upload_wechat_receipt').on('click', function() {
                wechatReceiptInput.click();
            });
            
            wechatReceiptInput.on('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                // 检查文件大小（压缩前限制10MB）
                if(file.size > 10 * 1024 * 1024){
                    layer.msg('图片大小不能超过10MB，请选择较小的图片', {icon: 2});
                    return;
                }
                
                // 预览原图
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#wechat_receipt_preview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
                
                // 压缩图片
                $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">正在压缩图片...</span>');
                compressImage(file, 1920, 1920, 0.8, function(compressedBlob){
                    // 显示压缩后的大小
                    var originalSize = (file.size / 1024 / 1024).toFixed(2);
                    var compressedSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                    $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">压缩完成（' + originalSize + 'MB → ' + compressedSize + 'MB），开始上传...</span>');
                    
                    // 上传压缩后的图片
                    uploadCompressedImage(
                        compressedBlob,
                        file.name.replace(/\.[^/.]+$/, '.jpg'),
                        '{:url("UpFiles/upload")}',
                        function(percent) {
                            $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">上传进度: ' + percent + '%</span>');
                        },
                        function(res) {
                            if(res.code == 1){
                                $('#wechat_receipt_image').val(res.url);
                                $('#wechat_receipt_text').html('<span style="color: #5FB878;">上传成功</span>');
                            } else {
                                $('#wechat_receipt_text').html('<span style="color: #FF5722;">上传失败：' + (res.info || '未知错误') + '</span>');
                            }
                        },
                        function(error) {
                            $('#wechat_receipt_text').html('<span style="color: #FF5722;">上传失败：' + error + '</span>');
                        }
                    );
                });
            });

            // 产品询盘分配图上传 - 使用隐藏的input
            var inquiryAssignInput = $('<input type="file" accept="image/*" style="display:none;" id="inquiry_assign_input">');
            $('body').append(inquiryAssignInput);
            
            $('#upload_inquiry_assign').on('click', function() {
                inquiryAssignInput.click();
            });
            
            inquiryAssignInput.on('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                // 检查文件大小（压缩前限制10MB）
                if(file.size > 10 * 1024 * 1024){
                    layer.msg('图片大小不能超过10MB，请选择较小的图片', {icon: 2});
                    return;
                }
                
                // 预览原图
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#inquiry_assign_preview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
                
                // 压缩图片
                $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">正在压缩图片...</span>');
                compressImage(file, 1920, 1920, 0.8, function(compressedBlob){
                    // 显示压缩后的大小
                    var originalSize = (file.size / 1024 / 1024).toFixed(2);
                    var compressedSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                    $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">压缩完成（' + originalSize + 'MB → ' + compressedSize + 'MB），开始上传...</span>');
                    
                    // 上传压缩后的图片
                    uploadCompressedImage(
                        compressedBlob,
                        file.name.replace(/\.[^/.]+$/, '.jpg'),
                        '{:url("UpFiles/upload")}',
                        function(percent) {
                            $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">上传进度: ' + percent + '%</span>');
                        },
                        function(res) {
                            if(res.code == 1){
                                $('#inquiry_assign_image').val(res.url);
                                $('#inquiry_assign_text').html('<span style="color: #5FB878;">上传成功</span>');
                            } else {
                                $('#inquiry_assign_text').html('<span style="color: #FF5722;">上传失败：' + (res.info || '未知错误') + '</span>');
                            }
                        },
                        function(error) {
                            $('#inquiry_assign_text').html('<span style="color: #FF5722;">上传失败：' + error + '</span>');
                        }
                    );
                });
            });



        // 表单提交监听
        form.on('submit(submit)', function (data) {
            // 检查联系方式是否已填写
            var contact = $("#contact").val();
            if (!contact || contact.trim() === '') {
                layer.msg('请先输入联系方式', { icon: 2, time: 2000 });
                return false;
            }
            
            // 检查用户属性是否已选择
            var customerTypeFlag = $("#customer_type_flag").val();
            if (!customerTypeFlag || customerTypeFlag === '') {
                layer.msg('请选择用户属性（公司或个人）', { icon: 2, time: 2000 });
                return false;
            }
            
            // 如果选择"公司"，检查客户公司是否已填写
            if (customerTypeFlag === '0') {
                var clientCompany = $("#client_company").val();
                if (!clientCompany || clientCompany.trim() === '') {
                    layer.msg('选择"公司"时，客户公司为必填项', { icon: 2, time: 2000 });
                    return false;
                }
            }
            
            // 检查票种性质是否已选择
            var invoiceType = $("#invoice_type").val();
            if (!invoiceType || invoiceType === '') {
                layer.msg('请选择票种性质', { icon: 2, time: 2000 });
                return false;
            }
            
            // 如果选择"普票"或"专票"，检查票种金额是否已填写
            if (invoiceType === '普票' || invoiceType === '专票') {
                var invoiceAmount = $("#invoice_amount").val();
                if (!invoiceAmount || invoiceAmount.trim() === '') {
                    layer.msg('选择"普票"或"专票"时，票种金额为必填项', { icon: 2, time: 2000 });
                    return false;
                }
            }
            
            // 如果客户未验证或验证失败，先触发验证
            if (!customerValidated) {
                // 先触发一次 changeyewu 验证
                var contactValue = contact.trim();
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    url: "{:url('Order/changeyewu')}" + "?contact=" + encodeURIComponent(contactValue),
                    async: false, // 同步请求，确保验证完成后再提交
                    success: function (result) {
                        if (result['msg']['code'] == 0) {
                            customerValidated = false;
                            layer.msg(result['msg']['msg'] || '该客户不属于您的客户或协同人客户，无法添加订单', { icon: 2, time: 3000 });
                        } else {
                            customerValidated = true;
                        }
                    },
                    error: function () {
                        customerValidated = false;
                        layer.msg('验证客户信息失败，请重试', { icon: 2, time: 2000 });
                    }
                });
            }
            
            // 如果验证失败，阻止提交
            if (!customerValidated) {
                return false;
            }

            // 检查两个图片是否已上传
            var wechatReceiptImage = $('#wechat_receipt_image').val();
            var inquiryAssignImage = $('#inquiry_assign_image').val();
            
            if (!wechatReceiptImage || wechatReceiptImage.trim() === '') {
                layer.msg('请上传客户微信回执图', { icon: 2, time: 2000 });
                return false;
            }
            
            if (!inquiryAssignImage || inquiryAssignImage.trim() === '') {
                layer.msg('请上传产品询盘分配图', { icon: 2, time: 2000 });
                return false;
            }

            // 提交前同步更新总计字段，以防用户未触发输入事件
            updateTotals();
            $.post("{:url('Order/add')}", data.field, function (res) {
                if (res.code === 0) {
                    layer.msg(res.msg, { time: 2000 }, function () {
                        layer.close(layer.index);
                        window.parent.location.reload();
                    });
                } else {
                    layer.msg(res.msg, { time: 2000 });
                }
            }, 'json');
            return false;
        });
        }); // 闭合 layui.use
    </script>
    <!-- 在页面底部新增脚本，实现联想下拉功能 -->
    <script>
        // 新增：客户公司输入联想下拉功能脚本
        $(function(){
            var searchTimer = null; // 防抖定时器
            var currentRequest = null; // 当前请求对象，用于取消未完成的请求
            
            // 监听客户公司输入框的输入事件
            $('#client_company').on('input', function(){
                var keyword = $.trim($(this).val());
                
                // 取消之前的定时器
                if (searchTimer) {
                    clearTimeout(searchTimer);
                }
                
                // 取消之前的请求
                if (currentRequest && currentRequest.readyState !== 4) {
                    currentRequest.abort();
                }
                
                if (keyword.length < 2) {
                    // 少于2个字符不触发联想，下拉列表隐藏
                    $('#companyList').hide();
                    return;
                }
                
                // 显示加载提示
                $('#companyList').html('<div style="padding:10px; text-align:center; color:#999;">正在搜索...</div>').show();
                
                // 防抖处理：延迟500ms后执行搜索
                searchTimer = setTimeout(function(){
                    // 发起 AJAX 请求获取企业名称联想列表
                    currentRequest = $.ajax({
                        type: 'GET',
                        url: "{:url('Order/searchCompany')}" + "?keyword=" + encodeURIComponent(keyword),
                        dataType: 'json',
                        timeout: 10000, // 10秒超时
                        success: function(res) {
                            if (res.code === 0) {
                                var dataList = res.data || [];
                                if (dataList.length > 0) {
                                    var listHtml = '';
                                    $.each(dataList, function(index, name) {
                                        // 高亮匹配的关键词
                                        var highlightedName = name;
                                        if (keyword) {
                                            var regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                                            highlightedName = name.replace(regex, '<strong style="color:#1E9FFF;">$1</strong>');
                                        }
                                        // 构造下拉项，每项显示企业名称
                                        listHtml += '<div class="suggestion-item" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f0f0f0;" onmouseover="this.style.backgroundColor=\'#f5f5f5\'" onmouseout="this.style.backgroundColor=\'#fff\'">' + highlightedName + '</div>';
                                    });
                                    $('#companyList').html(listHtml).show();
                                } else {
                                    // 无匹配结果时显示提示
                                    $('#companyList').html('<div style="padding:10px; text-align:center; color:#999;">未找到匹配的企业</div>').show();
                                }
                            } else {
                                // API返回错误
                                console.error('企业名称搜索失败:', res.msg || '未知错误');
                                $('#companyList').html('<div style="padding:10px; text-align:center; color:#ff5722;">搜索失败: ' + (res.msg || '未知错误') + '</div>').show();
                                // 3秒后自动隐藏错误提示
                                setTimeout(function(){
                                    $('#companyList').hide();
                                }, 3000);
                            }
                        },
                        error: function(xhr, status, error) {
                            if (status === 'abort') {
                                // 请求被取消，不显示错误
                                return;
                            }
                            console.error('企业名称联想接口请求失败:', status, error);
                            var errorMsg = '网络请求失败';
                            if (status === 'timeout') {
                                errorMsg = '请求超时，请稍后重试';
                            } else if (xhr.status === 0) {
                                errorMsg = '网络连接失败';
                            } else if (xhr.status >= 500) {
                                errorMsg = '服务器错误，请稍后重试';
                            }
                            $('#companyList').html('<div style="padding:10px; text-align:center; color:#ff5722;">' + errorMsg + '</div>').show();
                            // 3秒后自动隐藏错误提示
                            setTimeout(function(){
                                $('#companyList').hide();
                            }, 3000);
                        },
                        complete: function() {
                            currentRequest = null;
                        }
                    });
                }, 500); // 防抖延迟500ms
            });
            
            // 点击联想下拉项时，将企业名称填入输入框，并隐藏列表
            $(document).on('click', '.suggestion-item', function(){
                var companyName = $(this).text().replace(/<[^>]*>/g, ''); // 移除HTML标签，获取纯文本
                $('#client_company').val(companyName);
                $('#companyList').hide();
            });
            
            // 当输入框失去焦点时，稍作延迟后隐藏下拉列表（避免点击选中时过早隐藏）
            $('#client_company').on('blur', function(){
                setTimeout(function(){
                    $('#companyList').hide();
                }, 200);
            });
            
            // 点击页面其他地方时隐藏下拉列表
            $(document).on('click', function(e){
                if (!$(e.target).closest('#client_company, #companyList').length) {
                    $('#companyList').hide();
                }
            });
        });
    </script>
</body>

</html>