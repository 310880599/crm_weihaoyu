{include file="common/head"/}
<style>
  

.layui-input-group .layui-input {
  flex: 1;
  border-radius: 0;
}

.layui-input-group .layui-btn {
  border-radius: 0;
}
</style>
<!-- ★ 改造：订单审核通知（未读 / 已读 分区显示） -->
<style>
    .notice-box {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .notice-unread {
      background: #fff7e6; /* 未读：偏暖色 */
    }
    .notice-read {
      background: #f5f5f5; /* 已读：灰色 */
    }
    .notice-title {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notice-list {
      max-height: 260px;
      overflow: auto;
      padding-right: 4px;
    }
</style>
<link rel="stylesheet" type="text/css" href="/static/admin/css/admin.css" />

<div class="admin-main layui-anim layui-anim-upbit">

    <div class="layui-row ">
        <!-- 新增冲突查询 -->
        <div class="layui-row" style="margin-bottom: 20px;">
            <div class="layui-col-md12" style="text-align: left;">
                <form class="layui-form" action="{:url('client/conflict')}" method="get" style="display: inline-block;width:100%">
                    <div class="layui-inline layui-input-group" style="margin-right: 10px;width:92%">
                        <input type="text" name="keyword" placeholder="输入客户名称/手机号" autocomplete="off"
                            class="layui-input" style="width: 100%;">
                    </div>
                    
                    
                    
                    <button class="layui-btn layui-btn-normal" lay-submit style="width:7%" type="submit">
                        <i class="layui-icon layui-icon-search"></i> 冲突查询
                    </button>
                    
                    
                </form>
            </div>
        </div>

    </div>
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <!-- <div class="layui-card-header">
                            总线索
                            <span class="layui-badge layui-bg-blue layuiadmin-badge">周</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$cluesCount} 条</p>
                            <p>
                                总线索
                                <span class="layuiadmin-span-color">{$cluesCount} 条</span>
                            </p>
                        </div>
                    </div> -->
                    <div class="layui-card-header">
                            订单
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$orderCount} 个</p>
                            <p>
                                我的订单
                                <span class="layuiadmin-span-color">{$myOrderCount} 个</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            我的客户
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$clientCount_month}</p>
                            <p>
                                成交客户
                                <span class="layuiadmin-span-color">{$clientCount_cj} 个</span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            公海
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                            <!-- <span class="layui-badge layui-bg-green layuiadmin-badge">年</span> -->
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">{$liberumCount}</p>
                            <p>
                                总数据
                                <span class="layuiadmin-span-color">{$liberumCount_year} 条</span>
                            </p>
                        </div>
                    </div>
                </div>


                <!-- <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            成交
                            <span class="layui-badge layui-bg-orange layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">0</p>
                            <p>
                                成交率
                                <span class="layuiadmin-span-color">100% <i class="layui-inline layui-icon layui-icon-user"></i></span>
                            </p>
                        </div>
                    </div>
                </div>-->
            </div>
        </div>



    </div>


    <div class="layui-row layui-col-space15">

        <div class="layui-col-md8">
            <div class="layui-row layui-col-space15">

                <div class="layui-col-md12">

                    <div class="layui-card">
                        <div class="layui-card-header">绩效月排行</div>
                        <div class="layui-card-body">
                            <dl class="layuiadmin-card-status">
                                <table class="layui-table">
                                    <colgroup>
                                        <col width="100">
                                        <col>
                                    </colgroup>
                                    <!-- //月度排名（名）、月目标（元）、已成交（元）、完成率（%）、已成交（单）、提成点（%） -->
                                    <tbody>
                                        <tr>
                                            <td>月度排名</td>
                                            <td>业务员</td>
                                            <td>已成交（元）</td>
                                            <td>成单率（%）</td>
                                            <td>已成交（单）</td>
                                            <td>每月客户</td>
                                        </tr>
                                        {volist name='userlist' id='vo' key="k" }
                                        <tr>
                                            <td>{$k}</td>
                                            <td>{$vo['username']}</td>
                                            <td>{$vo['money_month']}</td>
                                            <td>  {if condition="$vo.client_count_month > 0"}
        {:round($vo['number_month'] / $vo['client_count_month'] * 100, 2)}%
    {else}
        0.00%
    {/if}</td>
                                            <td>{$vo['number_month']}</td>
                                            <td>{$vo.client_count_month}</td>
                                        </tr>
                                        {/volist}
                                    </tbody>
                                </table>

                            </dl>
                        </div>
                    </div>


                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">待办事项</div>
                <div class="layui-card-body layui-text">
                    <table class="layui-table">
                        <colgroup>
                            <col width="150">
                            <col>
                        </colgroup>
                        <tbody>

                            <tr>
                                <td>今日已跟进</td>
                                <td>
                                    {$today_count}
                                </td>
                            </tr>
                            <tr>
                                <td>未跟进个数</td>
                                <td>
                                    {$all_count}
                                </td>
                            </tr>
                            <tr>
                                <td>跟进率</td>
                                <td>
                                    {$genjinlv}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>




            <div class="layui-card">
                <div class="layui-card-header">
                    {$wenhou}
                    <i class="layui-icon layui-icon-tips" title="{:config('sys_name')}" lay-offset="5"></i>
                </div>
                <div class="layui-card-body layui-text layadmin-text">

                    <!-- 上面：未读通知（最多10条） -->
                    <div class="notice-box notice-unread">
                        <div class="notice-title">
                        <span>未读通知（最多10条）</span>
                        </div>
                    
                        <div class="notice-list">
                        {volist name='unreadNotifications' id='notice'}
                        <p class="notice-item notice-item-unread"
                            data-id="{$notice.id}"
                            data-type="{$notice.type}"
                            data-time="{$notice.create_time|date='m-d H:i'}"
                            data-msg="{$notice.message}"
                            style="margin: 5px 0; padding: 6px; border-left: 3px solid {if condition='$notice.type == 1'}green{else}red{/if}; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        
                            <span style="flex:1; min-width:0;">
                                <span style="color: {if condition='$notice.type == 1'}#5FB878{else}#FF5722{/if};">
                                    {$notice.message}
                                </span>
                                <span style="color: #999; font-size: 12px; margin-left: 10px;">
                                    ({$notice.create_time|date='m-d H:i'})
                                </span>
                            </span>
                        
                            <!-- ✅【新增】已读按钮 -->
                            <button type="button"
                                    class="layui-btn layui-btn-xs layui-btn-primary notice-mark-read-btn"
                                    data-id="{$notice.id}">
                                已读
                            </button>
                        </p>
                        {/volist}
                            
                    
                        {if condition='empty($unreadNotifications)'}
                        <p style="color: #999; font-size: 12px;">暂无未读通知</p>
                        {/if}
                        </div>
                    </div>
  
                    <!-- 下面：已读通知（最多5条） -->
                    <div class="notice-box notice-read">
                        <div class="notice-title">
                        <span>已读通知（最多5条）</span>
                        </div>
                    
                        <div class="notice-list" style="max-height: 160px;">
                        {volist name='readNotifications' id='notice'}
                        <p style="margin: 5px 0; padding: 6px; border-left: 3px solid #ccc;">
                            <span style="color: #666;">
                            {$notice.message}
                            </span>
                            <span style="color: #999; font-size: 12px; margin-left: 10px;">
                            ({$notice.create_time|date='m-d H:i'})
                            </span>
                        </p>
                        {/volist}    
                    
                        {if condition='empty($readNotifications)'}
                        <p style="color: #999; font-size: 12px;">暂无已读通知</p>
                        {/if}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space15">

        <div class="layui-col-md8">
            <div class="layui-row layui-col-space15">

                <div class="layui-col-md12">

                    <div class="layui-card">
                        <div class="layui-card-header">动态</div>
                        <div class="layui-card-body">
                            <dl class="layuiadmin-card-status">


                                {volist name='result' id='vo'}
                                <dd>
                                    <div class="layui-status-img"><a href="javascript:;">
                                            <img src="{$vo.avatar}"></a>
                                    </div>
                                    <div>
                                        <p>{$vo.username} <em style="color: red;margin-right: 5px">跟进</em> <a
                                                href="{:url('Client/dialogue')}?id={$vo.id}"> {$vo.kh_name}</a> </p>
                                        <p><strong style="color: burlywood;margin-right: 5px">跟进记录:
                                            </strong>{$vo.reply_msg}</p>
                                        <span>跟进时间：{$vo.create_date|date='Y-m-d H:i:s'}</span>
                                    </div>
                                </dd>
                                {/volist}

                            </dl>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
{include file="common/foot"/}
<script>
    layui.use(['table','jquery','layer'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var layer = layui.layer;
    
        // ✅【新增】点击“已读”
        $(document).on('click', '.notice-mark-read-btn', function () {
            var id = $(this).data('id');
            var $item = $(this).closest('.notice-item');
    
            // 防止重复点
            if ($(this).data('loading')) return;
            $(this).data('loading', 1).text('处理中...');
    
            $.ajax({
                url: "{:url('Index/markNotificationRead')}",
                type: "POST",
                dataType: "json",
                data: { id: id },
                success: function (res) {
                    if (!res || res.code != 1) {
                        layer.msg((res && res.msg) ? res.msg : '标记已读失败');
                        $item.find('.notice-mark-read-btn').data('loading', 0).text('已读');
                        return;
                    }
    
                    // ✅ 前端移动：从未读挪到已读
                    var msg = $item.attr('data-msg') || '';
                    var time = $item.attr('data-time') || '';
                    var readHtml =
                        '<p class="notice-item notice-item-read" data-id="'+id+'" ' +
                        'style="margin: 5px 0; padding: 6px; border-left: 3px solid #ccc;">' +
                        '  <span style="color: #666;">'+ escapeHtml(msg) +'</span>' +
                        '  <span style="color: #999; font-size: 12px; margin-left: 10px;">(' + escapeHtml(time) + ')</span>' +
                        '</p>';
    
                    // 已读列表容器（你的已读区域 .notice-read 里第一个 .notice-list）
                    var $readList = $('.notice-read .notice-list').first();
    
                    // 如果“暂无已读通知”存在，先删掉
                    $readList.find('p:contains("暂无已读通知")').remove();
    
                    // 插入到已读最顶部
                    $readList.prepend(readHtml);
    
                    // 删除未读项本身
                    $item.remove();
    
                    // ✅ 如果已读超过 5 条：前端也删掉最旧的（最后一条）
                    var $reads = $readList.find('p.notice-item-read');
                    if ($reads.length > 5) {
                        $reads.last().remove();
                    }
    
                    layer.msg('已标记为已读');
                },
                error: function () {
                    layer.msg('网络异常，标记失败');
                    $item.find('.notice-mark-read-btn').data('loading', 0).text('已读');
                }
            });
        });
    
        // ✅【新增】HTML 转义，避免消息里有特殊字符导致 DOM 错乱
        function escapeHtml(str){
            if (str === null || str === undefined) return '';
            return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
        }
    });
    
    // 原来的函数保留
    function searchConflict() {
        var keyword = $('input[name="keyword"]').val();
        if (!keyword) {
            layer.msg('请输入查询关键词');
            return false;
        }
        window.location.href = "{:url('Client/conflict')}?keyword=" + encodeURIComponent(keyword);
        return false;
    }
</script>
    
</body>

</html>